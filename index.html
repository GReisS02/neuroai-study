<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroAI ¬∑ Sistema de Estudos</title>
    
    <!-- Fontes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,400;14..32,500;14..32,600;14..32,700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        /* ===== RESET ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* ===== VARI√ÅVEIS - TEMA ESCURO ELEGANTE ===== */
        :root {
            /* Cores base - Escuras e sofisticadas */
            --bg-primary: #0a0c10;
            --bg-secondary: #111316;
            --bg-tertiary: #1a1d24;
            --bg-card: #15181e;
            --bg-sidebar: #0c0f14;
            --bg-hover: #1e222a;
            
            /* Bordas */
            --border-light: #2a2e36;
            --border-medium: #363b45;
            --border-dark: #404650;
            
            /* Texto */
            --text-primary: #eef2f6;
            --text-secondary: #b0b8c5;
            --text-tertiary: #7e8799;
            --text-muted: #5b6475;
            --text-disabled: #404650;
            
            /* Cores de destaque - Azul escuro sofisticado */
            --accent-primary: #2f6c9f;
            --accent-secondary: #3b7db3;
            --accent-tertiary: #4d8ec9;
            --accent-soft: #1d3142;
            --accent-glow: rgba(47, 108, 159, 0.3);
            
            /* Cores das disciplinas - Com fundo opacidade 0.3 */
            --disc-blue: #4d8ec9;
            --disc-blue-bg: rgba(77, 142, 201, 0.3);
            --disc-teal: #2f9e8f;
            --disc-teal-bg: rgba(47, 158, 143, 0.3);
            --disc-green: #5f9e7a;
            --disc-green-bg: rgba(95, 158, 122, 0.3);
            --disc-gold: #b8944d;
            --disc-gold-bg: rgba(184, 148, 77, 0.3);
            --disc-purple: #8f7ac9;
            --disc-purple-bg: rgba(143, 122, 201, 0.3);
            --disc-rose: #c97a9e;
            --disc-rose-bg: rgba(201, 122, 158, 0.3);
            
            /* Cores de status - Suaves */
            --green: #2b7a4b;
            --green-soft: #1a3022;
            --yellow: #8f6f2c;
            --yellow-soft: #2e2617;
            --red: #a14545;
            --red-soft: #2a1c1c;
            --purple: #5f4b8b;
            --purple-soft: #201b2a;
            --pink: #8b4b6d;
            --pink-soft: #251e24;
            --blue: #2f6c9f;
            --blue-soft: #1a2432;
            
            /* Cores das revis√µes */
            --rev-r1: #2f6c9f;
            --rev-r1-bg: rgba(47, 108, 159, 0.15);
            --rev-r7: #8f6f2c;
            --rev-r7-bg: rgba(143, 111, 44, 0.15);
            --rev-r15: #a14545;
            --rev-r15-bg: rgba(161, 69, 69, 0.15);
            --rev-r30: #2b7a4b;
            --rev-r30-bg: rgba(43, 122, 75, 0.15);
            --rev-r60: #5f4b8b;
            --rev-r60-bg: rgba(95, 75, 139, 0.15);
            --rev-r90: #8b4b6d;
            --rev-r90-bg: rgba(139, 75, 109, 0.15);
            
            /* Cores para toast notifications */
            --toast-success-bg: #1a3022;
            --toast-success-border: #2b7a4b;
            --toast-success-text: #2b7a4b;
            --toast-error-bg: #2a1c1c;
            --toast-error-border: #a14545;
            --toast-error-text: #a14545;
            --toast-warning-bg: #2e2617;
            --toast-warning-border: #8f6f2c;
            --toast-warning-text: #8f6f2c;
            --toast-info-bg: #1d3142;
            --toast-info-border: #2f6c9f;
            --toast-info-text: #2f6c9f;
            
            /* Espa√ßamentos */
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 0.75rem;
            --space-lg: 1.25rem;
            --space-xl: 2rem;
            
            /* Bordas */
            --radius-sm: 0.35rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-full: 9999px;
            
            /* Sombras */
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.5);
            --shadow-xl: 0 12px 24px rgba(0, 0, 0, 0.6);
            --shadow-glow: 0 0 0 2px var(--accent-glow);
        }

        body {
            font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            height: 100vh;
            overflow: hidden;
        }

        /* ===== TOAST NOTIFICATION ===== */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 350px;
        }

        .toast {
            padding: 12px 16px;
            border-radius: var(--radius-md);
            background: var(--bg-card);
            border-left: 4px solid transparent;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease forwards;
            cursor: pointer;
            border: 1px solid var(--border-light);
            backdrop-filter: blur(10px);
        }

        .toast:hover {
            transform: translateX(-5px);
            box-shadow: var(--shadow-xl);
        }

        .toast.success {
            border-left-color: var(--toast-success-border);
            background: var(--toast-success-bg);
        }
        .toast.success .toast-icon { color: var(--toast-success-text); }

        .toast.error {
            border-left-color: var(--toast-error-border);
            background: var(--toast-error-bg);
        }
        .toast.error .toast-icon { color: var(--toast-error-text); }

        .toast.warning {
            border-left-color: var(--toast-warning-border);
            background: var(--toast-warning-bg);
        }
        .toast.warning .toast-icon { color: var(--toast-warning-text); }

        .toast.info {
            border-left-color: var(--toast-info-border);
            background: var(--toast-info-bg);
        }
        .toast.info .toast-icon { color: var(--toast-info-text); }

        .toast-icon {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            font-size: 0.85rem;
            margin-bottom: 2px;
            color: var(--text-primary);
        }

        .toast-message {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .toast-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: currentColor;
            opacity: 0.3;
            animation: progress 3s linear forwards;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        @keyframes progress {
            from { width: 100%; }
            to { width: 0%; }
        }

        /* Loading overlay para opera√ß√µes ass√≠ncronas */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(3px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--bg-tertiary);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ===== LAYOUT ===== */
        .app {
            display: flex;
            height: 100vh;
            background: var(--bg-primary);
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            width: 280px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border-light);
            padding: var(--space-lg);
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: var(--shadow-lg);
            transition: transform 0.3s ease;
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                bottom: 0;
                z-index: 100;
                transform: translateX(-100%);
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .menu-toggle {
                display: block !important;
                position: fixed;
                top: 10px;
                left: 10px;
                z-index: 101;
                background: var(--bg-card);
                border: 1px solid var(--border-light);
                color: var(--text-primary);
                padding: 8px 12px;
                border-radius: var(--radius-md);
                cursor: pointer;
                font-size: 1.2rem;
            }
        }

        .menu-toggle {
            display: none;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin-bottom: var(--space-lg);
            padding: var(--space-sm) 0;
            border-bottom: 1px solid var(--border-light);
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: var(--accent-primary);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.1rem;
            box-shadow: var(--shadow-md);
        }

        .logo-text {
            font-size: 1.1rem;
            font-weight: 600;
            letter-spacing: -0.02em;
            color: var(--text-primary);
        }

        .logo-badge {
            font-size: 0.55rem;
            background: var(--bg-tertiary);
            color: var(--text-tertiary);
            padding: 0.15rem 0.35rem;
            border-radius: var(--radius-full);
            margin-left: auto;
            border: 1px solid var(--border-light);
        }

        .nav {
            flex: 1;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-sm) var(--space-md);
            margin-bottom: var(--space-xs);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .nav-item:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
            border-color: var(--border-medium);
        }

        .nav-item.active {
            background: var(--accent-soft);
            color: var(--accent-tertiary);
            border-color: var(--accent-primary);
        }

        .nav-item svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            stroke-width: 1.5;
            fill: none;
        }

        /* ===== STATUS SECTION ===== */
        .status-section {
            margin-top: auto;
            padding: var(--space-md);
            background: var(--bg-tertiary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-light);
        }

        .vital-sign {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-xs) 0;
            border-bottom: 1px solid var(--border-light);
            font-size: 0.8rem;
        }

        .vital-sign:last-child {
            border-bottom: none;
        }

        .vital-label {
            color: var(--text-tertiary);
            font-weight: 500;
        }

        .vital-value {
            color: var(--text-primary);
            font-weight: 600;
            font-family: "JetBrains Mono", monospace;
            font-size: 0.85rem;
        }

        .vital-value.online {
            color: var(--green);
        }

        .vital-value.offline {
            color: var(--text-tertiary);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-sm);
            background: var(--bg-hover);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-sm);
            border: 1px solid var(--border-light);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-full);
            border: 2px solid var(--accent-primary);
            object-fit: cover;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.8rem;
            color: var(--text-primary);
        }

        .user-email {
            font-size: 0.65rem;
            color: var(--text-tertiary);
        }

        /* ===== MAIN CONTENT ===== */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-xl);
            background: var(--bg-primary);
            scrollbar-width: thin;
            scrollbar-color: var(--border-medium) var(--bg-secondary);
        }

        .main-content::-webkit-scrollbar {
            width: 5px;
        }

        .main-content::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        .main-content::-webkit-scrollbar-thumb {
            background: var(--border-medium);
            border-radius: var(--radius-full);
        }

        /* ===== HEADER ===== */
        .page-header {
            margin-bottom: var(--space-lg);
            padding-bottom: var(--space-sm);
            border-bottom: 1px solid var(--border-light);
        }

        .page-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
            letter-spacing: -0.02em;
        }

        .page-subtitle {
            color: var(--text-tertiary);
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .memo-tag {
            background: var(--accent-soft);
            color: var(--accent-tertiary);
            padding: 0.15rem 0.5rem;
            border-radius: var(--radius-full);
            font-size: 0.65rem;
            border: 1px solid var(--accent-primary);
        }

        /* ===== CARDS ===== */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: var(--space-md);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-light);
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: var(--border-medium);
            box-shadow: var(--shadow-lg);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-sm);
            padding-bottom: var(--space-xs);
            border-bottom: 1px solid var(--border-light);
        }

        .card-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        .card-title small {
            font-size: 0.65rem;
            color: var(--text-tertiary);
            margin-left: var(--space-xs);
            font-weight: normal;
            text-transform: none;
        }

        /* ===== KPI GRID ===== */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-sm);
            margin-bottom: var(--space-lg);
        }

        @media (max-width: 1024px) {
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .kpi-grid {
                grid-template-columns: 1fr;
            }
        }

        .kpi-card {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: var(--space-sm) var(--space-md);
            border: 1px solid var(--border-light);
            transition: all 0.3s ease;
        }

        .kpi-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-tertiary);
            margin-bottom: var(--space-xs);
        }

        .kpi-value {
            font-size: 1.8rem;
            font-weight: 700;
            line-height: 1;
            color: var(--text-primary);
            margin-bottom: var(--space-xs);
            font-family: "JetBrains Mono", monospace;
        }

        .kpi-trend {
            font-size: 0.65rem;
            color: var(--text-tertiary);
        }

        /* ===== TABELA COM ATUALIZA√á√ÉO REATIVA ===== */
        .table-container {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-light);
            overflow: auto;
            box-shadow: var(--shadow-md);
            max-height: 65vh;
            font-size: 0.8rem;
            position: relative;
        }

        /* Indicador de loading para a tabela */
        .table-loading {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-tertiary), var(--accent-primary));
            background-size: 200% 100%;
            animation: loading 1.5s linear infinite;
            display: none;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 2400px;
        }

        th {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: var(--space-xs) var(--space-sm);
            text-align: left;
            border-bottom: 1px solid var(--border-light);
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
        }

        td {
            padding: var(--space-xs) var(--space-sm);
            border-bottom: 1px solid var(--border-light);
            color: var(--text-secondary);
            vertical-align: middle;
            transition: background-color 0.2s ease;
        }

        /* Highlight para c√©lulas atualizadas */
        td.updated {
            animation: highlight 0.5s ease;
        }

        @keyframes highlight {
            0% { background-color: var(--accent-soft); }
            100% { background-color: transparent; }
        }

        tr:hover td {
            background: var(--bg-hover);
        }

        /* Disciplina row - Colorida com fundo opacidade 0.3 */
        .disciplina-row {
            border-left: 3px solid transparent;
        }

        .disciplina-row td:first-child {
            border-top-left-radius: var(--radius-sm);
            border-bottom-left-radius: var(--radius-sm);
        }

        .disciplina-row[data-color="0"] { 
            border-left-color: var(--disc-blue);
            background: var(--disc-blue-bg);
        }
        .disciplina-row[data-color="1"] { 
            border-left-color: var(--disc-teal);
            background: var(--disc-teal-bg);
        }
        .disciplina-row[data-color="2"] { 
            border-left-color: var(--disc-green);
            background: var(--disc-green-bg);
        }
        .disciplina-row[data-color="3"] { 
            border-left-color: var(--disc-gold);
            background: var(--disc-gold-bg);
        }
        .disciplina-row[data-color="4"] { 
            border-left-color: var(--disc-purple);
            background: var(--disc-purple-bg);
        }
        .disciplina-row[data-color="5"] { 
            border-left-color: var(--disc-rose);
            background: var(--disc-rose-bg);
        }

        .disciplina-row td {
            color: var(--text-primary);
            font-weight: 600;
            border-bottom: 2px solid var(--border-medium);
        }

        .disciplina-name {
            color: inherit;
            font-weight: 600;
            background: transparent;
            border: none;
            padding: var(--space-xs) 0;
            width: auto;
            min-width: 200px;
        }

        .disciplina-name:focus {
            outline: none;
            color: var(--accent-tertiary);
        }

        /* Peso texto simples ao lado do nome */
        .peso-texto {
            color: var(--text-tertiary);
            font-size: 0.7rem;
            font-weight: 400;
            margin-left: 6px;
        }

        /* Inputs */
        .input-clean {
            background: transparent;
            border: 1px solid transparent;
            color: var(--text-primary);
            padding: 2px 4px;
            border-radius: var(--radius-sm);
            width: 100%;
            font-family: inherit;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }

        .input-clean:hover {
            background: var(--bg-tertiary);
            border-color: var(--border-light);
        }

        .input-clean:focus {
            outline: none;
            border-color: var(--accent-primary);
            background: var(--bg-secondary);
            box-shadow: var(--shadow-glow);
        }

        .input-mini {
            width: 38px;
            height: 26px;
            text-align: center;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-light);
            color: var(--text-primary);
            border-radius: var(--radius-sm);
            font-family: "JetBrains Mono", monospace;
            font-size: 0.75rem;
            padding: 2px;
            transition: all 0.2s ease;
        }

        .input-mini:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: var(--shadow-glow);
        }

        .input-mini.zero {
            color: var(--text-disabled);
            opacity: 0.5;
        }

        /* Slider para relev√¢ncia */
        .relevancia-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .relevancia-slider {
            width: 60px;
            height: 4px;
            -webkit-appearance: none;
            background: var(--bg-tertiary);
            border-radius: var(--radius-full);
            outline: none;
        }

        .relevancia-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            border-radius: var(--radius-full);
            background: var(--accent-primary);
            cursor: pointer;
            border: 2px solid var(--accent-tertiary);
        }

        .relevancia-slider::-moz-range-thumb {
            width: 12px;
            height: 12px;
            border-radius: var(--radius-full);
            background: var(--accent-primary);
            cursor: pointer;
            border: 2px solid var(--accent-tertiary);
        }

        /* Badge relev√¢ncia */
        .badge {
            display: inline-block;
            padding: 0.15rem 0.4rem;
            border-radius: var(--radius-full);
            font-size: 0.6rem;
            font-weight: 600;
            letter-spacing: 0.02em;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border-light);
        }

        .badge-relevancia.alta {
            background: var(--red-soft);
            color: var(--red);
            border-color: var(--red);
        }

        .badge-relevancia.media {
            background: var(--yellow-soft);
            color: var(--yellow);
            border-color: var(--yellow);
        }

        .badge-relevancia.baixa {
            background: var(--green-soft);
            color: var(--green);
            border-color: var(--green);
        }

        /* Checkbox */
        .checkbox-estudado {
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-medium);
            border-radius: var(--radius-sm);
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
            margin: 0 auto;
            display: block;
        }

        .checkbox-estudado:checked {
            background: var(--green-soft);
            border-color: var(--green);
        }

        .checkbox-estudado:checked::after {
            content: "‚úì";
            color: var(--green);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
            font-weight: bold;
        }

        .checkbox-estudado:hover {
            border-color: var(--green);
            background: var(--green-soft);
        }

        /* Status Dots */
        .status-dot {
            width: 20px;
            height: 20px;
            border-radius: var(--radius-sm);
            margin: 0 auto;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
        }

        .status-dot.done {
            background: var(--green-soft);
            border: 1px solid var(--green);
        }

        .status-dot.done::after {
            content: "‚úì";
            color: var(--green);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 11px;
            font-weight: bold;
        }

        .status-dot.pending {
            background: var(--red-soft);
            border: 1px solid var(--red);
            animation: pulse 2s infinite;
        }

        .status-dot.future {
            background: var(--bg-tertiary);
            border: 1px dashed var(--border-medium);
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Cores revis√µes */
        .rev-bg-r1 { background: var(--rev-r1-bg); }
        .rev-bg-r7 { background: var(--rev-r7-bg); }
        .rev-bg-r15 { background: var(--rev-r15-bg); }
        .rev-bg-r30 { background: var(--rev-r30-bg); }
        .rev-bg-r60 { background: var(--rev-r60-bg); }
        .rev-bg-r90 { background: var(--rev-r90-bg); }

        /* Container para A% - sem cor inicial, cores ap√≥s preenchimento */
        .rev-a-percent {
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .rev-percent-value {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-secondary); /* cor padr√£o */
            margin-left: 1px;
        }

        .rev-percent-value.green {
            color: var(--green);
        }

        .rev-percent-value.yellow {
            color: var(--yellow);
        }

        .rev-percent-value.red {
            color: var(--red);
        }

        /* Bot√µes */
        .btn {
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            font-weight: 500;
            font-size: 0.8rem;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s ease;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border-color: var(--border-light);
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }

        .btn:hover {
            background: var(--bg-hover);
            border-color: var(--border-medium);
        }

        .btn-primary {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-secondary);
        }

        .btn-primary:hover {
            background: var(--accent-secondary);
        }

        .btn-ai {
            background: var(--purple-soft);
            color: var(--purple);
            border-color: var(--purple);
        }

        .btn-ai:hover {
            background: rgba(95, 75, 139, 0.3);
        }

        /* Link TEC */
        .link-tec {
            color: var(--accent-tertiary);
            text-decoration: none;
            font-size: 0.7rem;
            display: inline-flex;
            align-items: center;
            gap: 0.2rem;
            padding: 0.15rem 0.3rem;
            border-radius: var(--radius-sm);
            background: var(--accent-soft);
            border: 1px solid var(--accent-primary);
            white-space: nowrap;
        }

        .link-tec:hover {
            background: var(--accent-primary);
            color: white;
        }

        /* Heatmap */
        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
            max-width: 280px;
        }

        .heatmap-cell {
            aspect-ratio: 1;
            border-radius: var(--radius-sm);
            background: var(--bg-tertiary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .heatmap-cell:hover {
            transform: scale(1.15);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--accent-primary);
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow: auto;
            padding: var(--space-lg);
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-light);
        }

        /* Alertas */
        .alert {
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-md);
            border-left: 4px solid transparent;
            font-size: 0.85rem;
        }

        .alert-warning {
            background: var(--yellow-soft);
            border-left-color: var(--yellow);
        }

        .alert-info {
            background: var(--accent-soft);
            border-left-color: var(--accent-primary);
        }

        /* Grids */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Bot√£o add t√≥pico */
        .btn-add-topico {
            background: transparent;
            border: none;
            color: var(--text-tertiary);
            font-size: 0.65rem;
            cursor: pointer;
            padding: 2px 4px;
            margin-left: 2px;
        }

        .btn-add-topico:hover {
            color: var(--accent-tertiary);
        }

        /* Fade in */
        .fade-in {
            animation: fadeIn 0.4s ease forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Toast Container -->
        <div id="toastContainer" class="toast-container"></div>
        
        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="loading-overlay">
            <div class="loading-spinner"></div>
        </div>

        <!-- Menu Toggle (Mobile) -->
        <button class="menu-toggle" id="menuToggle">‚ò∞</button>

        <!-- SIDEBAR -->
        <aside class="sidebar" id="sidebar">
            <div class="logo">
                <div class="logo-icon">üß†</div>
                <span class="logo-text">NeuroAI</span>
                <span class="logo-badge">v3.2</span>
            </div>

            <nav class="nav">
                <div class="nav-item active" onclick="showTab('dashboard')" id="nav-dashboard">
                    <svg viewBox="0 0 24 24">
                        <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
                    </svg>
                    Dashboard
                </div>
                <div class="nav-item" onclick="showTab('estudos')" id="nav-estudos">
                    <svg viewBox="0 0 24 24">
                        <path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9h-4v4h-2v-4H9V9h4V5h2v4h4v2z"/>
                    </svg>
                    Ciclo de Estudos
                </div>
                <div class="nav-item" onclick="showTab('metas')" id="nav-metas">
                    <svg viewBox="0 0 24 24">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                    Metas
                </div>
                <div class="nav-item" onclick="showTab('revisoes')" id="nav-revisoes">
                    <svg viewBox="0 0 24 24">
                        <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V9h14v10zM7 11h5v5H7v-5z"/>
                    </svg>
                    Calend√°rio
                </div>
            </nav>

            <!-- STATUS SECTION -->
            <div class="status-section">
                <div id="userProfile" class="user-profile" style="display: none;">
                    <img id="userAvatar" class="user-avatar" src="">
                    <div>
                        <div class="user-name" id="userName"></div>
                        <div class="user-email" id="userEmail"></div>
                    </div>
                </div>
                
                <button id="loginBtn" onclick="login()" class="btn btn-primary" style="width: 100%; margin-bottom: var(--space-sm);">Entrar com Google</button>
                <button id="logoutBtn" onclick="logout()" class="btn" style="width: 100%; margin-bottom: var(--space-sm); display: none;">Sair</button>
                
                <div class="vital-sign">
                    <span class="vital-label">Status</span>
                    <span class="vital-value" id="syncText">Offline</span>
                </div>
                <div class="vital-sign">
                    <span class="vital-label">Total Quest√µes</span>
                    <span class="vital-value" id="vitalTotal">0</span>
                </div>
                <div class="vital-sign">
                    <span class="vital-label">Desempenho</span>
                    <span class="vital-value" id="vitalPerf">0.0%</span>
                </div>
                <div class="vital-sign">
                    <span class="vital-label">Revis√µes Hoje</span>
                    <span class="vital-value" id="vitalRev">0</span>
                </div>
                <div class="vital-sign">
                    <span class="vital-label">Meta Semanal</span>
                    <span class="vital-value" id="vitalMeta">500</span>
                </div>
                <div class="vital-sign">
                    <span class="vital-label">Dias at√© Prova</span>
                    <span class="vital-value" id="vitalDias">90</span>
                </div>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="main-content" id="mainContent"></main>
    </div>

    <!-- MODAL -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-md);">
                <h3 style="font-size: 1.1rem; font-weight: 600;" id="modalTitulo">NeuroAI Assistente</h3>
                <button onclick="fecharModal()" style="background: none; border: none; font-size: 1.2rem; cursor: pointer; color: var(--text-tertiary);">‚úï</button>
            </div>
            <div id="modalLoading" style="display: none; text-align: center; padding: var(--space-md);">
                <div class="loading-spinner" style="width: 30px; height: 30px;"></div>
                <p style="margin-top: var(--space-sm); color: var(--accent-tertiary);">Processando...</p>
            </div>
            <div id="modalContent" style="font-size: 0.9rem;"></div>
        </div>
    </div>

    <script>
        // ========== FIREBASE CONFIG ==========
        const firebaseConfig = {
            apiKey: "AIzaSyB49R1ZycEX_4Q6vzaM7wNYdi5qf3Zfm2M",
            authDomain: "neuroai-study-3a97b.firebaseapp.com",
            projectId: "neuroai-study-3a97b",
            storageBucket: "neuroai-study-3a97b.appspot.com",
            messagingSenderId: "233819898876",
            appId: "1:233819898876:web:f48f18e06c6a13e91aa879"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const provider = new firebase.auth.GoogleAuthProvider();

        // ========== DADOS COMPLETOS DA PLANILHA ==========
        const DADOS_PLANILHA = [
            { disciplina: "ADMINISTRA√á√ÉO FINANCEIRA", peso: 2, topico: "Instrumentos Or√ßament√°rios", bloco: "Bloco II", cobranca: 0.171 },
            { disciplina: "ADMINISTRA√á√ÉO FINANCEIRA", peso: 2, topico: "Lei Complementar n¬∫ 101/2000", bloco: "Bloco VII", cobranca: 0.16 },
            { disciplina: "ADMINISTRA√á√ÉO FINANCEIRA", peso: 2, topico: "Or√ßamento P√∫blico", bloco: "Bloco I", cobranca: 0.135 },
            { disciplina: "ADMINISTRA√á√ÉO FINANCEIRA", peso: 2, topico: "Despesa p√∫blica", bloco: "Bloco V", cobranca: 0.123 },
            { disciplina: "AUDITORIA FISCAL", peso: 2, topico: "Testes em √°reas espec√≠ficas", bloco: "Bloco VI", cobranca: 0.2 },
            { disciplina: "AUDITORIA FISCAL", peso: 2, topico: "NFe e EFD", bloco: "Bloco VII", cobranca: 0.19 },
            { disciplina: "CONTABILIDADE GERAL", peso: 2, topico: "Demonstra√ß√µes Cont√°beis", bloco: "Bloco IX", cobranca: 0.311 },
            { disciplina: "CONTABILIDADE GERAL", peso: 2, topico: "Ativo", bloco: "Bloco III", cobranca: 0.219 },
            { disciplina: "DIREITO TRIBUT√ÅRIO", peso: 2, topico: "Limita√ß√µes ao Poder de Tributar", bloco: "Bloco II", cobranca: 0.116 },
            { disciplina: "DIREITO TRIBUT√ÅRIO", peso: 2, topico: "Tributos", bloco: "Bloco I", cobranca: 0.1 },
            { disciplina: "DIREITO ADMINISTRATIVO", peso: 1, topico: "Poderes da Administra√ß√£o", bloco: "Bloco II", cobranca: 0.095 },
            { disciplina: "DIREITO ADMINISTRATIVO", peso: 1, topico: "Servidores P√∫blicos", bloco: "Bloco IV", cobranca: 0.074 },
            { disciplina: "PORTUGU√äS", peso: 1, topico: "Interpreta√ß√£o de Textos", bloco: "Bloco VI", cobranca: 0.35 },
            { disciplina: "PORTUGU√äS", peso: 1, topico: "Concord√¢ncia", bloco: "Bloco IV", cobranca: 0.057 }
        ];

        // ========== VARI√ÅVEIS GLOBAIS ==========
        let appData = [];
        let usuarioAtual = null;
        let graficos = {};
        let filtroHojeAtivo = false;
        let metaSemanal = 500;
        let diasProva = 90;
        
        const REVISOES = [1, 7, 15, 30, 60, 90];
        const NOMES_REV = ['R1', 'R7', 'R15', 'R30', 'R60', 'R90'];

        let saveTimeout = null;

        // ========== UTILIT√ÅRIOS ==========
        function showToast({ title, message, type = 'info', duration = 3000 }) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = { success: '‚úì', error: '‚úï', warning: '‚ö†', info: '‚Ñπ' };
            
            toast.innerHTML = `
                <span class="toast-icon">${icons[type]}</span>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <div class="toast-progress" style="animation-duration: ${duration}ms;"></div>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease forwards';
                setTimeout(() => toast.remove(), 300);
            }, duration);
            
            toast.addEventListener('click', () => toast.remove());
        }

        function showLoading(show = true) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        function criarDadosIniciais() {
            const disciplinasMap = new Map();
            
            DADOS_PLANILHA.forEach(item => {
                if (!disciplinasMap.has(item.disciplina)) {
                    disciplinasMap.set(item.disciplina, {
                        id: crypto.randomUUID ? crypto.randomUUID() : 'd' + Date.now() + Math.random(),
                        nome: item.disciplina,
                        peso: item.peso,
                        expandido: true,
                        topicos: []
                    });
                }
                
                const disciplina = disciplinasMap.get(item.disciplina);
                const nomeCompleto = `${item.topico} - ${item.bloco}`;
                
                disciplina.topicos.push({
                    id: crypto.randomUUID ? crypto.randomUUID() : 'c' + Date.now() + Math.random(),
                    nome: nomeCompleto,
                    relevancia: Math.round(item.cobranca * 100),
                    link: '',
                    questoes: 0,
                    acertos: 0,
                    data: '',
                    revisoes: [0, 0, 0, 0, 0, 0],
                    revQuestoes: [0, 0, 0, 0, 0, 0],
                    revAcertos: [0, 0, 0, 0, 0, 0]
                });
            });
            
            return Array.from(disciplinasMap.values());
        }

        function carregarDados() {
            try {
                const salvos = localStorage.getItem('neuroai_estado_completo_v9');
                if (salvos) {
                    const estado = JSON.parse(salvos);
                    appData = estado.data || criarDadosIniciais();
                    metaSemanal = estado.meta || 500;
                    diasProva = estado.diasProva || 90;
                } else {
                    appData = criarDadosIniciais();
                }
            } catch (e) {
                appData = criarDadosIniciais();
            }
            
            // Atualizar sidebar
            document.getElementById('vitalMeta').textContent = metaSemanal;
            document.getElementById('vitalDias').textContent = diasProva;
            
            // Renderizar views
            renderizarViews();
            atualizarDashboard();
        }

        function salvarDados() {
            const estado = {
                data: appData,
                meta: metaSemanal,
                diasProva: diasProva
            };
            localStorage.setItem('neuroai_estado_completo_v9', JSON.stringify(estado));
        }

        // ========== AUTENTICA√á√ÉO ==========
        window.login = function() {
            showLoading(true);
            auth.signInWithPopup(provider)
                .then(() => showToast({ title: 'Login realizado', message: 'Bem-vindo!', type: 'success' }))
                .catch(error => showToast({ title: 'Erro', message: error.message, type: 'error' }))
                .finally(() => showLoading(false));
        };

        window.logout = function() {
            auth.signOut();
            showToast({ title: 'Logout', message: 'At√© logo!', type: 'info' });
        };

        auth.onAuthStateChanged(usuario => {
            usuarioAtual = usuario;
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const userProfile = document.getElementById('userProfile');
            const syncText = document.getElementById('syncText');
            
            if (usuario) {
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'block';
                userProfile.style.display = 'flex';
                document.getElementById('userAvatar').src = usuario.photoURL || '';
                document.getElementById('userName').textContent = usuario.displayName || 'Usu√°rio';
                document.getElementById('userEmail').textContent = usuario.email || '';
                syncText.textContent = 'Online';
                syncText.className = 'vital-value online';
            } else {
                loginBtn.style.display = 'block';
                logoutBtn.style.display = 'none';
                userProfile.style.display = 'none';
                syncText.textContent = 'Offline';
                syncText.className = 'vital-value offline';
            }
        });

        // ========== FUN√á√ÉO CORRIGIDA DE MUDAN√áA DE ABAS ==========
        window.showTab = function(tab) {
            console.log('Mudando para aba:', tab);
            
            // Esconder todas as views
            const views = ['dashboard', 'estudos', 'metas', 'revisoes'];
            views.forEach(v => {
                const el = document.getElementById(v + 'View');
                if (el) el.style.display = 'none';
            });
            
            // Mostrar a view selecionada
            const viewEl = document.getElementById(tab + 'View');
            if (viewEl) viewEl.style.display = 'block';
            
            // Atualizar navega√ß√£o
            views.forEach(v => {
                const navEl = document.getElementById('nav-' + v);
                if (navEl) navEl.classList.remove('active');
            });
            const activeNav = document.getElementById('nav-' + tab);
            if (activeNav) activeNav.classList.add('active');
            
            // A√ß√µes espec√≠ficas por aba
            if (tab === 'estudos') {
                desenharTabela();
            }
            if (tab === 'metas') {
                document.getElementById('diasProvaInput').value = diasProva;
                atualizarMetas();
            }
            if (tab === 'revisoes') {
                const stats = calcularEstatisticas();
                atualizarContadoresRevisoes(stats);
                desenharTimelineRevisoes();
            }
            
            // Fechar sidebar em mobile
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('open');
            }
        };

        // ========== RENDERIZA√á√ÉO DAS VIEWS ==========
        function renderizarViews() {
            const main = document.getElementById('mainContent');
            main.innerHTML = `
                <!-- DASHBOARD VIEW -->
                <div id="dashboardView" class="fade-in">
                    <div class="page-header">
                        <div class="page-title">Dashboard</div>
                        <div class="page-subtitle">
                            <span>Acompanhamento de estudos</span>
                            <span class="memo-tag">‚è∞ ${new Date().toLocaleTimeString()}</span>
                        </div>
                    </div>

                    <div style="display: flex; gap: var(--space-sm); margin-bottom: var(--space-md);">
                        <button onclick="consultCoach()" class="btn btn-ai">
                            <span>‚ú®</span> An√°lise com IA
                        </button>
                        <button onclick="exportarDados()" class="btn">
                            <span>üì•</span> Backup
                        </button>
                    </div>

                    <div id="coachFeedback" class="alert alert-info" style="display: none;">
                        <div id="coachText"></div>
                    </div>

                    <div class="kpi-grid">
                        <div class="kpi-card">
                            <div class="kpi-label">Total Quest√µes</div>
                            <div class="kpi-value" id="kpiTotal">0</div>
                            <div class="kpi-trend">resolvidas</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">Desempenho</div>
                            <div class="kpi-value" style="color: var(--accent-tertiary);" id="kpiPerf">0%</div>
                            <div class="kpi-trend">m√©dia de acertos</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">Revis√µes Hoje</div>
                            <div class="kpi-value" style="color: var(--yellow);" id="kpiRev">0</div>
                            <div class="kpi-trend">pendentes</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">Progresso</div>
                            <div class="kpi-value" style="color: var(--green);" id="kpi90d">0%</div>
                            <div class="kpi-trend">do ciclo</div>
                        </div>
                    </div>

                    <div class="dashboard-grid">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Heatmap <small>30 dias</small></div>
                            </div>
                            <div id="heatmap" class="heatmap-grid" style="margin-bottom: var(--space-xs);"></div>
                            <div style="display: flex; align-items: center; gap: var(--space-xs); font-size: 0.7rem; color: var(--text-tertiary);">
                                <span>Menos</span>
                                <div style="display: flex; gap: 2px;">
                                    <div style="width: 14px; height: 14px; background: var(--bg-tertiary); border-radius: 3px;"></div>
                                    <div style="width: 14px; height: 14px; background: var(--green-soft); border-radius: 3px;"></div>
                                    <div style="width: 14px; height: 14px; background: #1e4620; border-radius: 3px;"></div>
                                    <div style="width: 14px; height: 14px; background: #2d6a4f; border-radius: 3px;"></div>
                                    <div style="width: 14px; height: 14px; background: #40916c; border-radius: 3px;"></div>
                                </div>
                                <span>Mais</span>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">√öltimos 7 dias</div>
                            </div>
                            <div style="display: flex; gap: var(--space-md); margin-bottom: var(--space-xs);">
                                <div>
                                    <div style="font-size: 1.8rem; font-weight: 700; line-height: 1; color: var(--accent-tertiary);" id="perf7d">0%</div>
                                    <div style="font-size: 0.7rem; color: var(--text-tertiary);">aproveitamento</div>
                                </div>
                                <div style="display: flex; gap: var(--space-sm);">
                                    <div>
                                        <div style="font-size: 0.65rem; color: var(--text-tertiary);">Quest√µes</div>
                                        <div style="font-weight: 600; font-size: 1rem;" id="total7d">0</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.65rem; color: var(--text-tertiary);">Acertos</div>
                                        <div style="font-weight: 600; font-size: 1rem; color: var(--green);" id="acertos7d">0</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.65rem; color: var(--text-tertiary);">Erros</div>
                                        <div style="font-weight: 600; font-size: 1rem; color: var(--red);" id="erros7d">0</div>
                                    </div>
                                </div>
                            </div>
                            <div style="height: 50px;">
                                <canvas id="chartEvolucao"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="dashboard-grid">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Desempenho por Disciplina</div>
                            </div>
                            <div style="height: 220px;">
                                <canvas id="chartDisciplinas"></canvas>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Distribui√ß√£o de Revis√µes</div>
                            </div>
                            <div style="height: 220px;">
                                <canvas id="chartRevisoes"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ESTUDOS VIEW -->
                <div id="estudosView" style="display: none;" class="fade-in">
                    <div class="page-header">
                        <div class="page-title">Ciclo de Estudos</div>
                        <div class="page-subtitle">
                            <span>R1 ¬∑ R7 ¬∑ R15 ¬∑ R30 ¬∑ R60 ¬∑ R90</span>
                            <span class="memo-tag">90 dias</span>
                        </div>
                    </div>

                    <div style="display: flex; gap: var(--space-xs); margin-bottom: var(--space-md); flex-wrap: wrap;">
                        <button onclick="showAddDisciplina()" class="btn btn-primary" style="padding: 0.4rem 0.8rem; font-size: 0.75rem;">+ Nova Disciplina</button>
                        <button onclick="toggleFiltroHoje()" id="btnHoje" class="btn" style="padding: 0.4rem 0.8rem; font-size: 0.75rem;">üî• Hoje</button>
                        <button onclick="analisarPrioridades()" class="btn btn-ai" style="padding: 0.4rem 0.8rem; font-size: 0.75rem;">üéØ Prioridades IA</button>
                    </div>

                    <div id="addForm" class="card" style="display: none; margin-bottom: var(--space-md); padding: var(--space-sm);">
                        <div style="display: flex; gap: var(--space-xs);">
                            <input type="text" id="novaDisciplina" placeholder="Nome da disciplina" class="input-clean" style="flex: 1; font-size: 0.8rem;">
                            <select id="pesoDisciplina" style="width: 70px; background: var(--bg-tertiary); border: 1px solid var(--border-light); border-radius: var(--radius-sm); color: var(--text-primary); padding: 0.2rem;">
                                <option value="3">Peso 3</option>
                                <option value="2" selected>Peso 2</option>
                                <option value="1">Peso 1</option>
                            </select>
                            <button onclick="addDisciplina()" class="btn btn-primary" style="padding: 0.3rem 0.6rem; font-size: 0.7rem;">Salvar</button>
                            <button onclick="hideAddDisciplina()" class="btn" style="padding: 0.3rem 0.6rem; font-size: 0.7rem;">Cancelar</button>
                        </div>
                    </div>

                    <div id="revisoesAlert" class="alert alert-warning" style="display: none; margin-bottom: var(--space-md); padding: var(--space-xs) var(--space-sm);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span id="revisoesText" style="font-size: 0.8rem;"></span>
                            <button onclick="mostrarRevisoesHoje()" class="btn btn-ai" style="padding: 0.2rem 0.6rem; font-size: 0.7rem;">Ver</button>
                        </div>
                    </div>

                    <div class="table-container" id="tabelaContainer"></div>
                </div>

                <!-- METAS VIEW -->
                <div id="metasView" style="display: none;" class="fade-in">
                    <div class="page-header">
                        <div class="page-title">Metas e Objetivos</div>
                        <div class="page-subtitle">Acompanhe seu progresso no ciclo de 90 dias</div>
                    </div>

                    <div class="dashboard-grid">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">üìÖ Meta Semanal</div>
                            </div>
                            <div style="margin-bottom: var(--space-sm);">
                                <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-xs); font-size: 0.8rem;">
                                    <span style="color: var(--text-tertiary);">Progresso</span>
                                    <span id="progressoMeta">0 / 500</span>
                                </div>
                                <div style="height: 6px; background: var(--bg-tertiary); border-radius: var(--radius-full); overflow: hidden;">
                                    <div id="barraProgresso" style="height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent-primary), var(--accent-tertiary)); border-radius: var(--radius-full);"></div>
                                </div>
                            </div>
                            <div style="display: flex; gap: var(--space-xs);">
                                <input type="number" id="metaInput" value="500" class="input-clean" style="width: 80px; font-size: 0.8rem;">
                                <button onclick="atualizarMeta()" class="btn btn-primary" style="padding: 0.3rem 0.8rem; font-size: 0.7rem;">Atualizar</button>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">‚è±Ô∏è Dias at√© a Prova</div>
                            </div>
                            <div style="font-size: 2rem; font-weight: 700; color: var(--accent-tertiary); margin-bottom: var(--space-xs);" id="previsaoEdital">-</div>
                            <div style="color: var(--text-tertiary); font-size: 0.8rem; margin-bottom: var(--space-sm);">dias restantes</div>
                            <div style="display: flex; gap: var(--space-xs); align-items: center; margin-bottom: var(--space-md);">
                                <input type="number" id="diasProvaInput" value="90" min="1" max="365" class="input-clean" style="width: 80px; font-size: 0.8rem;">
                                <button onclick="atualizarDiasProva()" class="btn btn-primary" style="padding: 0.3rem 0.8rem; font-size: 0.7rem;">Atualizar</button>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-xs); font-size: 0.8rem;">
                                    <span style="color: var(--text-tertiary);">Progresso do ciclo</span>
                                    <span id="progressoCiclo">0%</span>
                                </div>
                                <div style="height: 6px; background: var(--bg-tertiary); border-radius: var(--radius-full); overflow: hidden;">
                                    <div id="barraCiclo" style="height: 100%; width: 0%; background: linear-gradient(90deg, var(--green), var(--accent-primary)); border-radius: var(--radius-full);"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- REVISOES VIEW -->
                <div id="revisoesView" style="display: none;" class="fade-in">
                    <div class="page-header">
                        <div class="page-title">Calend√°rio de Revis√µes</div>
                        <div class="page-subtitle">Pr√≥ximas revis√µes dos pr√≥ximos 30 dias</div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: var(--space-xs); margin-bottom: var(--space-md);">
                        <div class="card" style="text-align: center; padding: var(--space-sm);">
                            <div style="color: var(--rev-r1); font-weight: 600; font-size: 0.7rem; margin-bottom: 2px;">R1</div>
                            <div style="font-size: 1.5rem; font-weight: 700;" id="countR1">0</div>
                        </div>
                        <div class="card" style="text-align: center; padding: var(--space-sm);">
                            <div style="color: var(--rev-r7); font-weight: 600; font-size: 0.7rem; margin-bottom: 2px;">R7</div>
                            <div style="font-size: 1.5rem; font-weight: 700;" id="countR7">0</div>
                        </div>
                        <div class="card" style="text-align: center; padding: var(--space-sm);">
                            <div style="color: var(--rev-r15); font-weight: 600; font-size: 0.7rem; margin-bottom: 2px;">R15</div>
                            <div style="font-size: 1.5rem; font-weight: 700;" id="countR15">0</div>
                        </div>
                        <div class="card" style="text-align: center; padding: var(--space-sm);">
                            <div style="color: var(--rev-r30); font-weight: 600; font-size: 0.7rem; margin-bottom: 2px;">R30</div>
                            <div style="font-size: 1.5rem; font-weight: 700;" id="countR30">0</div>
                        </div>
                        <div class="card" style="text-align: center; padding: var(--space-sm);">
                            <div style="color: var(--rev-r60); font-weight: 600; font-size: 0.7rem; margin-bottom: 2px;">R60</div>
                            <div style="font-size: 1.5rem; font-weight: 700;" id="countR60">0</div>
                        </div>
                        <div class="card" style="text-align: center; padding: var(--space-sm);">
                            <div style="color: var(--rev-r90); font-weight: 600; font-size: 0.7rem; margin-bottom: 2px;">R90</div>
                            <div style="font-size: 1.5rem; font-weight: 700;" id="countR90">0</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Pr√≥ximas revis√µes</div>
                        </div>
                        <div id="timelineRevisoes" style="max-height: 350px; overflow-y: auto; font-size: 0.8rem;"></div>
                    </div>
                </div>
            `;
        }

        // ========== FUN√á√ïES DE C√ÅLCULO ==========
        function calcularEstatisticas() {
            let totalQuestoes = 0, totalAcertos = 0, revisoesHoje = 0;
            const hoje = new Date(); hoje.setHours(0,0,0,0);
            const statsPorDisciplina = {};
            const revisoesPorDia = [0,0,0,0,0,0];
            
            appData.forEach(disciplina => {
                if (!statsPorDisciplina[disciplina.nome]) {
                    statsPorDisciplina[disciplina.nome] = { questoes: 0, acertos: 0 };
                }
                
                disciplina.topicos.forEach(topico => {
                    totalQuestoes += topico.questoes || 0;
                    totalAcertos += topico.acertos || 0;
                    statsPorDisciplina[disciplina.nome].questoes += topico.questoes || 0;
                    statsPorDisciplina[disciplina.nome].acertos += topico.acertos || 0;
                    
                    if (topico.data) {
                        const dataBase = new Date(topico.data);
                        dataBase.setHours(0,0,0,0);
                        REVISOES.forEach((dias, idx) => {
                            const dataRev = new Date(dataBase);
                            dataRev.setDate(dataRev.getDate() + dias);
                            if (dataRev <= hoje && !topico.revisoes[idx]) {
                                revisoesHoje++;
                                revisoesPorDia[idx]++;
                            }
                        });
                    }
                });
            });
            
            return {
                totalQuestoes,
                totalAcertos,
                revisoesHoje,
                revisoesPorDia,
                desempenho: totalQuestoes > 0 ? (totalAcertos / totalQuestoes * 100) : 0,
                statsPorDisciplina
            };
        }

        // ========== FUN√á√ïES DE A√á√ÉO COM HIGHLIGHT ==========
        window.atualizarRelevancia = function(discId, topId, valor, elemento) {
            const disc = appData.find(d => d.id === discId);
            const top = disc?.topicos.find(t => t.id === topId);
            if (top) {
                top.relevancia = parseInt(valor) || 0;
                highlightCell(elemento);
                salvarDados();
                
                const badge = elemento.closest('td').querySelector('.badge');
                if (badge) {
                    let relevanciaClass = 'baixa';
                    if (top.relevancia >= 20) relevanciaClass = 'alta';
                    else if (top.relevancia >= 10) relevanciaClass = 'media';
                    
                    badge.className = `badge badge-relevancia ${relevanciaClass}`;
                    badge.textContent = top.relevancia + '%';
                    highlightCell(badge);
                }
            }
        };

        window.atualizarDisciplina = function(id, campo, valor, elemento) {
            const disc = appData.find(d => d.id === id);
            if (disc) {
                disc[campo] = campo === 'peso' ? parseInt(valor) : valor;
                highlightCell(elemento);
                salvarDados();
            }
        };

        window.atualizarTopico = function(discId, topId, campo, valor, elemento) {
            const disc = appData.find(d => d.id === discId);
            const top = disc?.topicos.find(t => t.id === topId);
            
            if (top) {
                if (campo.includes('revQuestoes') || campo.includes('revAcertos')) {
                    const [tipo, index] = campo.split('_');
                    top[tipo][parseInt(index)] = parseInt(valor) || 0;
                } else {
                    top[campo] = campo === 'questoes' || campo === 'acertos' ? parseInt(valor) || 0 : valor;
                }
                
                highlightCell(elemento);
                salvarDados();
                atualizarDashboard();
                
                if (campo === 'questoes' || campo === 'acertos') {
                    atualizarPercentual(discId, topId);
                }
            }
        };

        window.atualizarRev = function(discId, topId, index, campo, valor, elemento) {
            const chave = `${campo}_${index}`;
            atualizarTopico(discId, topId, chave, valor, elemento);
            
            const disc = appData.find(d => d.id === discId);
            const top = disc?.topicos.find(t => t.id === topId);
            if (top) {
                const percCell = document.querySelector(`[data-rev-perc="${discId}_${topId}_${index}"]`);
                if (percCell) {
                    const revPerc = top.revQuestoes[index] > 0 ? Math.round(top.revAcertos[index] / top.revQuestoes[index] * 100) : 0;
                    let revPercClass = '';
                    if (top.revQuestoes[index] > 0) {
                        if (revPerc >= 85) revPercClass = 'green';
                        else if (revPerc >= 70) revPercClass = 'yellow';
                        else revPercClass = 'red';
                    }
                    
                    percCell.textContent = revPerc + '%';
                    percCell.className = `rev-percent-value ${revPercClass}`;
                    highlightCell(percCell);
                }
            }
        };

        function highlightCell(element) {
            if (element) {
                element.classList.add('updated');
                setTimeout(() => {
                    element.classList.remove('updated');
                }, 500);
            }
        }

        function atualizarPercentual(disciplinaId, topicoId) {
            const disc = appData.find(d => d.id === disciplinaId);
            const top = disc?.topicos.find(t => t.id === topicoId);
            
            if (top) {
                const percCell = document.querySelector(`[data-perc="${disciplinaId}_${topicoId}"]`);
                if (percCell) {
                    const perc = top.questoes > 0 ? Math.round(top.acertos / top.questoes * 100) : 0;
                    let percClass = '';
                    if (perc >= 70) percClass = 'green';
                    else if (perc >= 50) percClass = 'yellow';
                    else percClass = 'red';
                    
                    percCell.textContent = perc + '%';
                    percCell.className = percClass;
                    highlightCell(percCell);
                }
            }
        }

        // ========== RENDERIZA√á√ÉO DA TABELA ==========
        function desenharTabela() {
            const container = document.getElementById('tabelaContainer');
            if (!container) return;
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th style="width: 16px;"></th>
                            <th>DISCIPLINA / T√ìPICO - BLOCO</th>
                            <th style="width: 70px;">RELEV</th>
                            <th style="width: 70px;">LINK</th>
                            <th style="width: 35px;">VISTO</th>
                            <th style="width: 40px;">QTD</th>
                            <th style="width: 40px;">AC</th>
                            <th style="width: 35px;">%</th>
                            <th colspan="3" style="width: 95px;">R1</th>
                            <th colspan="3" style="width: 95px;">R7</th>
                            <th colspan="3" style="width: 95px;">R15</th>
                            <th colspan="3" style="width: 95px;">R30</th>
                            <th colspan="3" style="width: 95px;">R60</th>
                            <th colspan="3" style="width: 95px;">R90</th>
                            <th style="width: 20px;"></th>
                        </tr>
                        <tr>
                            <th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th>
                            <th>S</th><th>Q</th><th>A%</th>
                            <th>S</th><th>Q</th><th>A%</th>
                            <th>S</th><th>Q</th><th>A%</th>
                            <th>S</th><th>Q</th><th>A%</th>
                            <th>S</th><th>Q</th><th>A%</th>
                            <th>S</th><th>Q</th><th>A%</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            const hoje = new Date(); hoje.setHours(0,0,0,0);
            let colorIndex = 0;
            
            appData.forEach(disciplina => {
                if (!filtroHojeAtivo) {
                    html += `
                        <tr class="disciplina-row" data-color="${colorIndex % 6}">
                            <td onclick="toggleDisciplina('${disciplina.id}')" style="cursor: pointer; text-align: center; font-size: 0.8rem;">${disciplina.expandido ? '‚ñº' : '‚ñ∂'}</td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 2px; flex-wrap: wrap;">
                                    <input class="disciplina-name" value="${disciplina.nome.replace(/"/g, '&quot;')}" onblur="atualizarDisciplina('${disciplina.id}', 'nome', this.value, this)" style="font-size: 0.85rem; font-weight: 600;">
                                    <span class="peso-texto">Peso: ${disciplina.peso}</span>
                                    <button onclick="addTopico('${disciplina.id}')" class="btn-add-topico" title="Adicionar t√≥pico">+</button>
                                </div>
                            </td>
                            <td colspan="20"></td>
                        </tr>
                    `;
                    colorIndex++;
                }
                
                if (disciplina.expandido || filtroHojeAtivo) {
                    disciplina.topicos.forEach(topico => {
                        if (filtroHojeAtivo) {
                            let temRevisao = false;
                            if (topico.data) {
                                const dataBase = new Date(topico.data);
                                dataBase.setHours(0,0,0,0);
                                REVISOES.forEach((dias, idx) => {
                                    const dataRev = new Date(dataBase);
                                    dataRev.setDate(dataRev.getDate() + dias);
                                    if (dataRev <= hoje && !topico.revisoes[idx]) temRevisao = true;
                                });
                            }
                            if (!temRevisao) return;
                        }
                        
                        const perc = topico.questoes > 0 ? Math.round(topico.acertos / topico.questoes * 100) : 0;
                        const percClass = perc >= 70 ? 'green' : perc >= 50 ? 'yellow' : 'red';
                        
                        let relevanciaClass = 'baixa';
                        if (topico.relevancia >= 20) relevanciaClass = 'alta';
                        else if (topico.relevancia >= 10) relevanciaClass = 'media';
                        
                        html += `
                            <tr data-disciplina="${disciplina.id}" data-topico="${topico.id}">
                                <td></td>
                                <td><input class="input-clean" value="${topico.nome.replace(/"/g, '&quot;')}" onblur="atualizarTopico('${disciplina.id}', '${topico.id}', 'nome', this.value, this)" style="font-size: 0.8rem;"></td>
                                <td style="text-align: center;">
                                    <div class="relevancia-container">
                                        <span class="badge badge-relevancia ${relevanciaClass}">${topico.relevancia}%</span>
                                        <input type="range" min="0" max="100" value="${topico.relevancia}" class="relevancia-slider" onchange="atualizarRelevancia('${disciplina.id}', '${topico.id}', this.value, this)">
                                    </div>
                                </td>
                                <td style="text-align: center;">
                                    <div style="display: flex; align-items: center; gap: 2px;">
                                        <input class="input-clean" style="width: 45px; font-size: 0.7rem; padding: 2px;" placeholder="Link" value="${topico.link || ''}" onblur="atualizarTopico('${disciplina.id}', '${topico.id}', 'link', this.value, this)">
                                        ${topico.link ? `<a href="${topico.link}" target="_blank" class="link-tec">üîó</a>` : ''}
                                    </div>
                                </td>
                                <td style="text-align: center;">
                                    <input type="checkbox" class="checkbox-estudado" ${topico.data ? 'checked' : ''} onchange="marcarData('${disciplina.id}', '${topico.id}', this.checked, this)">
                                </td>
                                <td style="text-align: center;"><input class="input-mini ${topico.questoes === 0 ? 'zero' : ''}" value="${topico.questoes}" onchange="atualizarTopico('${disciplina.id}', '${topico.id}', 'questoes', this.value, this)"></td>
                                <td style="text-align: center;"><input class="input-mini ${topico.acertos === 0 ? 'zero' : ''}" value="${topico.acertos}" onchange="atualizarTopico('${disciplina.id}', '${topico.id}', 'acertos', this.value, this)"></td>
                                <td style="text-align: center; font-weight: 600;" data-perc="${disciplina.id}_${topico.id}"><span class="${percClass}">${perc}%</span></td>
                        `;
                        
                        for (let i = 0; i < 6; i++) {
                            const statusClass = topico.revisoes[i] ? 'done' : 
                                (topico.data && new Date(new Date(topico.data).getTime() + REVISOES[i]*24*60*60*1000) <= hoje ? 'pending' : 'future');
                            
                            const revPerc = topico.revQuestoes[i] > 0 ? Math.round(topico.revAcertos[i] / topico.revQuestoes[i] * 100) : 0;
                            
                            let revPercClass = '';
                            if (topico.revQuestoes[i] > 0) {
                                if (revPerc >= 85) revPercClass = 'green';
                                else if (revPerc >= 70) revPercClass = 'yellow';
                                else revPercClass = 'red';
                            }
                            
                            const revBgClass = i === 0 ? 'rev-bg-r1' : i === 1 ? 'rev-bg-r7' : i === 2 ? 'rev-bg-r15' : i === 3 ? 'rev-bg-r30' : i === 4 ? 'rev-bg-r60' : 'rev-bg-r90';
                            
                            html += `
                                <td class="${revBgClass}" style="text-align: center; padding: 2px;">
                                    <div class="status-dot ${statusClass}" onclick="marcarRevisao('${disciplina.id}', '${topico.id}', ${i}, this)"></div>
                                </td>
                                <td class="${revBgClass}" style="text-align: center; padding: 2px;">
                                    <input class="input-mini ${topico.revQuestoes[i] === 0 ? 'zero' : ''}" value="${topico.revQuestoes[i] || 0}" onchange="atualizarRev('${disciplina.id}', '${topico.id}', ${i}, 'revQuestoes', this.value, this)">
                                </td>
                                <td class="${revBgClass}" style="text-align: center; padding: 2px;">
                                    <div class="rev-a-percent">
                                        <input class="input-mini ${topico.revAcertos[i] === 0 ? 'zero' : ''}" value="${topico.revAcertos[i] || 0}" onchange="atualizarRev('${disciplina.id}', '${topico.id}', ${i}, 'revAcertos', this.value, this)">
                                        <span class="rev-percent-value ${revPercClass}" data-rev-perc="${disciplina.id}_${topico.id}_${i}">${revPerc}%</span>
                                    </div>
                                </td>
                            `;
                        }
                        
                        html += `<td style="text-align: center;"><button onclick="deletarTopico('${disciplina.id}', '${topico.id}')" style="background: none; border: none; color: var(--red); cursor: pointer; font-size: 0.8rem;">‚úï</button></td></tr>`;
                    });
                }
            });
            
            if (filtroHojeAtivo && html.indexOf('<tr') === -1) {
                html += '<tr><td colspan="30" style="text-align: center; padding: var(--space-lg); color: var(--text-tertiary);">üéØ Nenhuma revis√£o pendente para hoje</td></tr>';
            }
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // ========== FUN√á√ïES DE A√á√ÉO DA TABELA ==========
        window.marcarData = function(discId, topId, checked, elemento) {
            const disc = appData.find(d => d.id === discId);
            const top = disc?.topicos.find(t => t.id === topId);
            if (top) {
                top.data = checked ? new Date().toISOString().split('T')[0] : '';
                highlightCell(elemento);
                salvarDados();
                atualizarDashboard();
                desenharTabela();
            }
        };

        window.marcarRevisao = function(discId, topId, index, elemento) {
            const disc = appData.find(d => d.id === discId);
            const top = disc?.topicos.find(t => t.id === topId);
            if (top) {
                top.revisoes[index] = top.revisoes[index] ? 0 : 1;
                highlightCell(elemento);
                salvarDados();
                atualizarDashboard();
                
                const hoje = new Date(); hoje.setHours(0,0,0,0);
                const statusClass = top.revisoes[index] ? 'done' : 
                    (top.data && new Date(new Date(top.data).getTime() + REVISOES[index]*24*60*60*1000) <= hoje ? 'pending' : 'future');
                
                elemento.className = `status-dot ${statusClass}`;
            }
        };

        window.toggleDisciplina = function(id) {
            const disc = appData.find(d => d.id === id);
            if (disc) {
                disc.expandido = !disc.expandido;
                salvarDados();
                desenharTabela();
            }
        };

        window.addTopico = function(discId) {
            const disc = appData.find(d => d.id === discId);
            if (disc) {
                disc.topicos.push({
                    id: crypto.randomUUID ? crypto.randomUUID() : 'c' + Date.now() + Math.random(),
                    nome: 'Novo T√≥pico - Bloco ?',
                    relevancia: 10,
                    link: '',
                    questoes: 0,
                    acertos: 0,
                    data: '',
                    revisoes: [0,0,0,0,0,0],
                    revQuestoes: [0,0,0,0,0,0],
                    revAcertos: [0,0,0,0,0,0]
                });
                disc.expandido = true;
                salvarDados();
                desenharTabela();
                showToast({ title: 'T√≥pico adicionado', message: 'Novo t√≥pico criado!', type: 'success' });
            }
        };

        window.deletarTopico = function(discId, topId) {
            if (confirm('Tem certeza que deseja excluir este t√≥pico?')) {
                const disc = appData.find(d => d.id === discId);
                if (disc) {
                    disc.topicos = disc.topicos.filter(t => t.id !== topId);
                    salvarDados();
                    desenharTabela();
                    atualizarDashboard();
                    showToast({ title: 'T√≥pico exclu√≠do', message: 'Removido com sucesso', type: 'info' });
                }
            }
        };

        window.showAddDisciplina = function() {
            document.getElementById('addForm').style.display = 'block';
        };

        window.hideAddDisciplina = function() {
            document.getElementById('addForm').style.display = 'none';
        };

        window.addDisciplina = function() {
            const nome = document.getElementById('novaDisciplina').value.trim();
            if (!nome) {
                showToast({ title: 'Erro', message: 'Digite o nome da disciplina', type: 'warning' });
                return;
            }
            
            const peso = parseInt(document.getElementById('pesoDisciplina').value);
            appData.push({
                id: crypto.randomUUID ? crypto.randomUUID() : 'd' + Date.now() + Math.random(),
                nome: nome,
                peso: peso,
                expandido: true,
                topicos: []
            });
            
            document.getElementById('novaDisciplina').value = '';
            hideAddDisciplina();
            salvarDados();
            desenharTabela();
            showToast({ title: 'Disciplina adicionada', message: `"${nome}" criada!`, type: 'success' });
        };

        window.toggleFiltroHoje = function() {
            filtroHojeAtivo = !filtroHojeAtivo;
            const btn = document.getElementById('btnHoje');
            if (btn) {
                btn.style.background = filtroHojeAtivo ? 'var(--accent-soft)' : '';
                btn.style.borderColor = filtroHojeAtivo ? 'var(--accent-primary)' : '';
            }
            desenharTabela();
        };

        // ========== DASHBOARD ==========
        function atualizarDashboard() {
            const stats = calcularEstatisticas();
            
            document.getElementById('kpiTotal').textContent = stats.totalQuestoes;
            document.getElementById('kpiPerf').textContent = stats.desempenho.toFixed(1) + '%';
            document.getElementById('kpiRev').textContent = stats.revisoesHoje;
            document.getElementById('vitalTotal').textContent = stats.totalQuestoes;
            document.getElementById('vitalPerf').textContent = stats.desempenho.toFixed(1) + '%';
            document.getElementById('vitalRev').textContent = stats.revisoesHoje;
            document.getElementById('vitalMeta').textContent = metaSemanal;
            document.getElementById('vitalDias').textContent = diasProva;
            
            let primeiraData = null;
            appData.forEach(d => d.topicos.forEach(t => { if (t.data) { const dt = new Date(t.data); if (!primeiraData || dt < primeiraData) primeiraData = dt; } }));
            
            const diasEstudo = primeiraData ? Math.ceil((new Date() - primeiraData) / (1000*60*60*24)) : 0;
            const progressoCiclo = Math.min(100, (diasEstudo / diasProva * 100));
            document.getElementById('kpi90d').textContent = progressoCiclo.toFixed(0) + '%';
            
            document.getElementById('previsaoEdital').textContent = Math.max(0, diasProva - diasEstudo);
            document.getElementById('progressoCiclo').textContent = progressoCiclo.toFixed(0) + '%';
            document.getElementById('barraCiclo').style.width = progressoCiclo + '%';
            
            desenharHeatmap();
            calcularUltimos7Dias();
            atualizarGraficos(stats);
            atualizarContadoresRevisoes(stats);
        }

        function desenharHeatmap() {
            const container = document.getElementById('heatmap');
            if (!container) return;
            
            const hoje = new Date();
            let html = '';
            for (let i = 29; i >= 0; i--) {
                const data = new Date(); data.setDate(hoje.getDate() - i);
                const dataStr = data.toISOString().split('T')[0];
                let questoes = 0;
                appData.forEach(d => d.topicos.forEach(t => { if (t.data === dataStr) questoes += t.questoes || 0; }));
                
                let cor = 'var(--bg-tertiary)';
                if (questoes > 0) {
                    if (questoes < 5) cor = '#1a3022';
                    else if (questoes < 10) cor = '#1e4620';
                    else if (questoes < 15) cor = '#2d6a4f';
                    else cor = '#40916c';
                }
                html += `<div class="heatmap-cell" style="background: ${cor};" title="${dataStr}: ${questoes} quest√µes"></div>`;
            }
            container.innerHTML = html;
        }

        function calcularUltimos7Dias() {
            const hoje = new Date();
            let total = 0, acertos = 0;
            const dados = [];
            
            for (let i = 6; i >= 0; i--) {
                const data = new Date(); data.setDate(hoje.getDate() - i);
                const dataStr = data.toISOString().split('T')[0];
                let q = 0, a = 0;
                appData.forEach(d => d.topicos.forEach(t => { if (t.data === dataStr) { q += t.questoes || 0; a += t.acertos || 0; } }));
                total += q; acertos += a; dados.push(q);
            }
            
            document.getElementById('perf7d').textContent = total > 0 ? (acertos/total*100).toFixed(1) + '%' : '0%';
            document.getElementById('total7d').textContent = total;
            document.getElementById('acertos7d').textContent = acertos;
            document.getElementById('erros7d').textContent = total - acertos;
            
            if (graficos.evolucao) {
                graficos.evolucao.data.datasets[0].data = dados;
                graficos.evolucao.update();
            }
        }

        function atualizarGraficos(stats) {
            const ctxDisc = document.getElementById('chartDisciplinas')?.getContext('2d');
            if (ctxDisc) {
                const labels = Object.keys(stats.statsPorDisciplina);
                const data = labels.map(l => {
                    const d = stats.statsPorDisciplina[l];
                    return d.questoes > 0 ? (d.acertos / d.questoes * 100) : 0;
                });
                
                if (graficos.disciplinas) graficos.disciplinas.destroy();
                graficos.disciplinas = new Chart(ctxDisc, {
                    type: 'bar',
                    data: { labels, datasets: [{ label: 'Desempenho %', data, backgroundColor: '#2f6c9f', borderRadius: 4 }] },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        scales: { 
                            y: { max: 100, grid: { color: '#2a2e36' }, ticks: { color: '#7e8799', font: { size: 9 } } },
                            x: { ticks: { color: '#7e8799', font: { size: 8 } } }
                        },
                        plugins: { legend: { labels: { color: '#b0b8c5', font: { size: 9 } } } }
                    }
                });
            }
            
            const ctxRev = document.getElementById('chartRevisoes')?.getContext('2d');
            if (ctxRev) {
                if (graficos.revisoes) graficos.revisoes.destroy();
                graficos.revisoes = new Chart(ctxRev, {
                    type: 'doughnut',
                    data: {
                        labels: NOMES_REV,
                        datasets: [{ 
                            data: stats.revisoesPorDia, 
                            backgroundColor: ['#2f6c9f', '#8f6f2c', '#a14545', '#2b7a4b', '#5f4b8b', '#8b4b6d'],
                            borderWidth: 0
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { 
                            legend: { 
                                position: 'bottom', 
                                labels: { 
                                    color: '#b0b8c5', 
                                    font: { size: 8 },
                                    boxWidth: 10,
                                    padding: 8
                                } 
                            } 
                        } 
                    }
                });
            }
            
            const ctxEvo = document.getElementById('chartEvolucao')?.getContext('2d');
            if (ctxEvo && !graficos.evolucao) {
                graficos.evolucao = new Chart(ctxEvo, {
                    type: 'line',
                    data: { labels: ['D-6','D-5','D-4','D-3','D-2','D-1','Hoje'], datasets: [{ data: [0,0,0,0,0,0,0], borderColor: '#5f4b8b', borderWidth: 2, tension: 0.4, pointRadius: 1 }] },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        scales: { x: { display: false }, y: { display: false } }, 
                        plugins: { legend: { display: false } } 
                    }
                });
            }
        }

        function atualizarContadoresRevisoes(stats) {
            document.getElementById('countR1').textContent = stats.revisoesPorDia[0];
            document.getElementById('countR7').textContent = stats.revisoesPorDia[1];
            document.getElementById('countR15').textContent = stats.revisoesPorDia[2];
            document.getElementById('countR30').textContent = stats.revisoesPorDia[3];
            document.getElementById('countR60').textContent = stats.revisoesPorDia[4];
            document.getElementById('countR90').textContent = stats.revisoesPorDia[5];
            
            const alerta = document.getElementById('revisoesAlert');
            if (alerta) {
                if (stats.revisoesHoje > 0) {
                    alerta.style.display = 'block';
                    document.getElementById('revisoesText').textContent = `Voc√™ tem ${stats.revisoesHoje} revis√µes pendentes para hoje`;
                } else {
                    alerta.style.display = 'none';
                }
            }
        }

        // ========== METAS ==========
        function atualizarMetas() {
            const stats = calcularEstatisticas();
            document.getElementById('progressoMeta').textContent = `${stats.totalQuestoes} / ${metaSemanal}`;
            document.getElementById('barraProgresso').style.width = Math.min(100, (stats.totalQuestoes/metaSemanal*100)) + '%';
        }

        window.atualizarMeta = function() {
            const val = parseInt(document.getElementById('metaInput').value) || 500;
            metaSemanal = val;
            salvarDados();
            atualizarMetas();
            document.getElementById('vitalMeta').textContent = val;
            showToast({ title: 'Meta atualizada', message: `Nova meta: ${val}`, type: 'success' });
        };

        window.atualizarDiasProva = function() {
            const input = document.getElementById('diasProvaInput');
            const novosDias = parseInt(input.value);
            if (novosDias > 0 && novosDias <= 365) {
                diasProva = novosDias;
                document.getElementById('vitalDias').textContent = diasProva;
                salvarDados();
                atualizarDashboard();
                showToast({ title: 'Meta atualizada', message: `Dias at√© a prova: ${diasProva}`, type: 'success' });
            } else {
                showToast({ title: 'Valor inv√°lido', message: 'Digite um valor entre 1 e 365.', type: 'warning' });
            }
        };

        // ========== REVIS√ïES ==========
        function desenharTimelineRevisoes() {
            const hoje = new Date();
            let timeline = '';
            
            for (let d = 0; d < 30; d++) {
                const data = new Date(); data.setDate(hoje.getDate() + d);
                let count = 0, tipos = [];
                
                appData.forEach(disc => disc.topicos.forEach(t => {
                    if (t.data) {
                        const base = new Date(t.data); base.setHours(0,0,0,0);
                        REVISOES.forEach((dias, idx) => {
                            const rev = new Date(base); rev.setDate(rev.getDate() + dias);
                            if (rev.toDateString() === data.toDateString() && !t.revisoes[idx]) {
                                count++;
                                tipos.push(NOMES_REV[idx]);
                            }
                        });
                    }
                }));
                
                if (count > 0) {
                    const tiposUnicos = [...new Set(tipos)].join(', ');
                    timeline += `<div style="display: flex; gap: var(--space-sm); padding: var(--space-xs); border-bottom: 1px solid var(--border-light); font-size: 0.8rem;">
                        <span style="color: var(--accent-tertiary); font-weight: 600; min-width: 35px;">+${d}d</span>
                        <span style="min-width: 85px;">${data.toLocaleDateString()}</span>
                        <span style="color: var(--text-tertiary);">${count} revis√µes (${tiposUnicos})</span>
                    </div>`;
                }
            }
            
            document.getElementById('timelineRevisoes').innerHTML = timeline || '<p style="color: var(--text-tertiary); padding: var(--space-sm); font-size: 0.9rem;">Nenhuma revis√£o programada</p>';
        }

        // ========== IA SIMULADA ==========
        window.consultCoach = function() {
            const stats = calcularEstatisticas();
            const fb = document.getElementById('coachFeedback');
            const txt = document.getElementById('coachText');
            
            fb.style.display = 'block';
            txt.innerHTML = '<div class="loading-spinner" style="width: 18px; height: 18px; display: inline-block; margin-right: 8px;"></div> Analisando...';
            
            setTimeout(() => {
                let diag = stats.desempenho < 50 ? 'üî¥ Base te√≥rica fraca.' : stats.desempenho < 70 ? 'üü° Conhecimento m√©dio.' : 'üü¢ Bom desempenho!';
                txt.innerHTML = `<div style="font-size: 0.9rem;"><p><strong>Diagn√≥stico:</strong> ${diag}</p>
                                 <p><strong>Hoje:</strong> ${stats.revisoesHoje} revis√µes</p>
                                 <p><strong>Meta:</strong> ${metaSemanal - stats.totalQuestoes} quest√µes restantes</p>
                                 <p><strong>Dias at√© a prova:</strong> ${diasProva}</p></div>`;
                
                showToast({ title: 'An√°lise conclu√≠da', message: 'Confira as recomenda√ß√µes!', type: 'info' });
            }, 1000);
        };

        window.analisarPrioridades = function() {
            const prioridades = [];
            appData.forEach(d => d.topicos.forEach(t => {
                const perc = t.questoes > 0 ? (t.acertos/t.questoes*100) : 0;
                if (t.questoes > 0 && perc < 60) prioridades.push({ disciplina: d.nome, topico: t.nome, perc: Math.round(perc) });
            }));
            prioridades.sort((a,b) => a.perc - b.perc);
            
            let html = '<h3 style="font-size: 1rem; margin-bottom: 0.5rem;">Prioridades</h3>';
            if (prioridades.length === 0) html += '<p style="font-size: 0.9rem;">Nenhuma prioridade!</p>';
            else prioridades.slice(0,5).forEach(p => html += `<p style="font-size: 0.9rem; margin-bottom: 0.3rem;"><strong>${p.disciplina}:</strong> ${p.topico} (${p.perc}%)</p>`);
            
            abrirModal('Prioridades IA', html);
        };

        window.mostrarRevisoesHoje = function() {
            const hoje = new Date(); hoje.setHours(0,0,0,0);
            let html = '<h3 style="font-size: 1rem; margin-bottom: 0.5rem;">Revis√µes de hoje</h3>';
            let encontrou = false;
            
            appData.forEach(d => d.topicos.forEach(t => {
                if (t.data) {
                    const base = new Date(t.data); base.setHours(0,0,0,0);
                    REVISOES.forEach((dias, idx) => {
                        const rev = new Date(base); rev.setDate(rev.getDate() + dias);
                        if (rev <= hoje && !t.revisoes[idx]) {
                            encontrou = true;
                            html += `<p style="font-size: 0.9rem; margin-bottom: 0.3rem;"><span style="color: ${idx===0?'#2f6c9f':idx===1?'#8f6f2c':idx===2?'#a14545':idx===3?'#2b7a4b':idx===4?'#5f4b8b':'#8b4b6d'}; font-weight: 600;">${NOMES_REV[idx]}</span> - ${d.nome}: ${t.nome}</p>`;
                        }
                    });
                }
            }));
            
            if (!encontrou) html += '<p style="font-size: 0.9rem;">Nenhuma revis√£o pendente! üéâ</p>';
            abrirModal('Revis√µes do dia', html);
        };

        // ========== EXPORTA√á√ÉO ==========
        window.exportarDados = function() {
            const estadoCompleto = {
                data: appData,
                meta: metaSemanal,
                diasProva: diasProva,
                dataExport: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(estadoCompleto, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `neuroai_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            showToast({ title: 'Backup realizado', message: 'Dados exportados!', type: 'success' });
        };

        // ========== MODAL ==========
        function abrirModal(titulo, conteudo) {
            document.getElementById('modalTitulo').textContent = titulo;
            document.getElementById('modalContent').innerHTML = conteudo;
            document.getElementById('modalLoading').style.display = 'none';
            document.getElementById('modal').style.display = 'flex';
        }

        window.fecharModal = function() {
            document.getElementById('modal').style.display = 'none';
        };

        // ========== EVENTOS GLOBAIS ==========
        document.getElementById('menuToggle').addEventListener('click', function() {
            document.getElementById('sidebar').classList.toggle('open');
        });

        window.addEventListener('online', () => {
            showToast({ title: 'Conex√£o restaurada', message: 'Sincronizando...', type: 'success' });
        });

        window.addEventListener('offline', () => {
            showToast({ title: 'Modo offline', message: 'Trabalhando offline', type: 'warning' });
        });

        window.onclick = e => { if (e.target === document.getElementById('modal')) fecharModal(); };

        // ========== INICIALIZA√á√ÉO ==========
        window.onload = function() {
            carregarDados();
            
            // Mostrar dashboard inicial
            setTimeout(() => {
                showTab('dashboard');
            }, 100);
        };
    </script>
</body>
</html>