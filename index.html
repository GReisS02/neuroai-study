<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>NeuroStudy AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyB49R1ZycEX_4Q6vzaM7wNYdi5qf3Zfm2M",
          authDomain: "neuroai-study-3a97b.firebaseapp.com",
          projectId: "neuroai-study-3a97b",
          storageBucket: "neuroai-study-3a97b.firebasestorage.app",
          messagingSenderId: "233819898876",
          appId: "1:233819898876:web:f48f18e06c6a13e91aa879"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        const appId = 'neuro-fiscal-app'; 
        let userId = null;

        window.firebaseApp = { 
            login: async () => {
                try { await signInWithPopup(auth, provider); } 
                catch (error) { alert("Erro ao logar: " + error.message); }
            },
            logout: async () => {
                try { await signOut(auth); window.location.reload(); } 
                catch (error) { console.error("Erro ao sair:", error); }
            }
        };

        onAuthStateChanged(auth, (user) => {
            const loginBtn = document.getElementById('btn-login');
            const userProfile = document.getElementById('user-profile');
            const userImg = document.getElementById('user-avatar');
            
            if (user) {
                userId = user.uid;
                window.userId = userId;
                if(loginBtn) loginBtn.style.display = 'none';
                if(userProfile) userProfile.style.display = 'flex';
                if(userImg) userImg.src = user.photoURL || '';
                updateSyncStatus('online');
                setupRealtimeListener();
            } else {
                if(loginBtn) loginBtn.style.display = 'flex';
                if(userProfile) userProfile.style.display = 'none';
                updateSyncStatus('offline');
            }
        });

        function setupRealtimeListener() {
            if (!userId) return;
            const docRef = doc(db, 'artifacts', appId, 'users', userId, 'data', 'study_cycle');
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data && data.payload) {
                        try {
                            window.appData = JSON.parse(data.payload);
                            window.renderTable(window.isFilterTodayActive, true); 
                            window.updateStats();
                        } catch (e) { console.error("Erro dados", e); }
                    }
                } else { window.saveData(true); }
            }, (error) => updateSyncStatus('error'));
        }

        window.saveData = async function(force = false) {
            try { localStorage.setItem('neuro_fiscal_pro_v6', JSON.stringify(window.appData)); } catch(e) {}
            if (!userId) return;
            const docRef = doc(db, 'artifacts', appId, 'users', userId, 'data', 'study_cycle');
            try {
                await setDoc(docRef, { 
                    payload: JSON.stringify(window.appData),
                    lastUpdate: new Date().toISOString(),
                    userEmail: auth.currentUser.email
                });
            } catch (e) { console.error("Erro save", e); }
            window.updateStats();
        };

        function updateSyncStatus(status) {
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('status-text');
            if (!dot || !text) return;
            if (status === 'online') {
                text.innerText = 'Online';
                text.style.color = '#10b981';
                dot.style.background = '#10b981';
            } else {
                text.innerText = 'Offline';
                text.style.color = '#64748b';
                dot.style.background = '#64748b';
            }
        }
    </script>

    <style>
        :root {
            /* Palette Clean Dark v2 */
            --bg-body: #0b0e14;       
            --bg-sidebar: #0f1218;    
            --bg-card: #151a23;       
            --bg-hover: #1c222e;      
            --border: #252b36;        
            
            --text-primary: #ffffff;
            --text-secondary: #9ca3af; 
            --text-tertiary: #64748b;
            
            --accent-blue: #3b82f6; 
            --accent-green: #10b981;
            --accent-purple: #8b5cf6;
        }

        * { box-sizing: border-box; }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 250px;
            background-color: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 24px;
            flex-shrink: 0;
        }

        .logo-area {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 40px;
        }

        .nav-section-title {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
            margin-top: 16px;
            font-weight: 600;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 2px;
        }

        .nav-item:hover {
            background-color: var(--bg-hover);
            color: var(--text-primary);
        }

        .nav-item.active {
            background-color: #1e2532;
            color: var(--text-primary);
            border-left: 3px solid var(--accent-blue);
        }

        .status-area {
            margin-top: auto;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        /* --- MAIN CONTENT --- */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 32px;
            background-color: var(--bg-body);
        }

        /* --- CARDS & PANELS --- */
        .card {
            background-color: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background-color: var(--bg-card);
            border-radius: 8px;
            padding: 20px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100px;
        }

        .kpi-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .kpi-value {
            font-size: 2.2rem;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1;
        }

        /* --- TABLE STYLE (CLEAN) --- */
        .table-container {
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow-x: auto;
            background-color: var(--bg-card);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }

        th {
            background-color: #1a1f29;
            color: var(--text-secondary);
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
            padding: 14px 10px;
            border-bottom: 1px solid var(--border);
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }
        th.text-left { text-align: left; }

        td {
            padding: 12px 10px;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
            color: var(--text-primary);
            vertical-align: middle;
        }

        /* Linhas */
        .tr-disciplina td {
            background-color: #12161d;
            font-weight: 600;
            font-size: 1rem;
            color: #fff;
            padding-top: 18px;
            padding-bottom: 18px;
        }

        .tr-conteudo td { background-color: var(--bg-card); }
        .tr-conteudo:hover td { background-color: var(--bg-hover); }

        /* Inputs Clean */
        .input-clean {
            background: transparent;
            border: 1px solid transparent;
            color: inherit;
            font-size: inherit;
            font-weight: inherit;
            padding: 6px 8px;
            border-radius: 4px;
            width: 100%;
            outline: none;
            transition: 0.2s;
        }
        
        .input-clean:hover { background-color: rgba(255,255,255,0.05); }
        
        .input-clean:focus {
            background-color: #0b0e14;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 1px var(--accent-blue);
        }

        /* Mini Inputs for Reviews */
        .input-mini {
            width: 32px; height: 26px; font-size: 0.7rem; text-align: center;
            background: #11141d; border: 1px solid #30363d; color: #d1d5db;
            border-radius: 4px; outline: none; transition: 0.15s;
        }
        .input-mini:focus { border-color: var(--accent-blue); background: #0b0e14; color: white; }

        /* Checkbox */
        .checkbox-clean {
            appearance: none;
            width: 18px; height: 18px;
            border: 2px solid #4b5563;
            border-radius: 4px;
            background: transparent;
            cursor: pointer;
            position: relative;
        }
        .checkbox-clean:checked {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
        }
        .checkbox-clean:checked::after {
            content: 'âœ“'; color: white; font-size: 12px;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        }

        /* Status Dot */
        .status-dot {
            width: 8px; height: 8px; border-radius: 50%;
            background: #2d3442; margin: 0 auto;
        }
        .status-dot.done { background: var(--accent-green); box-shadow: 0 0 6px rgba(16,185,129,0.3); }
        .status-dot.pending { background: #ef4444; box-shadow: 0 0 6px rgba(239,68,68,0.3); }
        .status-dot.today { background: #f59e0b; box-shadow: 0 0 6px rgba(245,158,11,0.3); }

        /* Buttons */
        .btn {
            padding: 8px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 500;
            cursor: pointer; border: 1px solid transparent; transition: 0.2s;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-primary { background-color: var(--accent-blue); color: white; }
        .btn-primary:hover { background-color: #2563eb; }
        
        .btn-secondary { background-color: var(--bg-hover); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-secondary:hover { border-color: var(--text-secondary); background-color: #2a303e; }
        
        .btn-ai {
            background-color: rgba(139, 92, 246, 0.1); 
            color: var(--accent-purple); 
            border: 1px solid rgba(139, 92, 246, 0.3);
        }
        .btn-ai:hover { 
            background-color: rgba(139, 92, 246, 0.2); 
            box-shadow: 0 0 12px rgba(139, 92, 246, 0.15);
        }

        .btn-text { background: transparent; color: var(--accent-blue); padding: 0; font-size: 0.8rem; }
        .btn-text:hover { text-decoration: underline; }
        
        .btn-icon-only {
            padding: 4px;
            color: var(--text-secondary);
            background: transparent;
            border-radius: 4px;
            cursor: pointer;
            transition: 0.2s;
            border: none;
        }
        .btn-icon-only:hover { color: var(--accent-purple); background: var(--bg-hover); }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #333b4d; border-radius: 3px; }
        ::-webkit-scrollbar-track { background: transparent; }

        /* Logo Gradient Text */
        .logo-text {
            font-size: 1.25rem;
            font-weight: 700;
            background: linear-gradient(90deg, #60a5fa 0%, #34d399 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.02em;
        }

        .border-l-rev { border-left: 1px solid var(--border); }
        
        /* Markdown Styles */
        .markdown-content h1, .markdown-content h2 { font-size: 1.1em; font-weight: bold; color: white; margin-bottom: 0.5em; }
        .markdown-content ul { list-style: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .markdown-content li { margin-bottom: 0.3em; }
        .markdown-content strong { color: var(--accent-blue); }
        .markdown-content p { margin-bottom: 0.8em; }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="logo-area">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20Z" fill="#3b82f6"/>
                <path d="M12 6C9 6 7 8 7 11C7 14 9 16 12 16C15 16 17 14 17 11C17 8 15 6 12 6ZM12 14C10.5 14 9.5 13 9.5 11.5C9.5 10 10.5 9 12 9C13.5 9 14.5 10 14.5 11.5C14.5 13 13.5 14 12 14Z" fill="white"/>
                <circle cx="15.5" cy="9.5" r="1.5" fill="#3b82f6"/>
                <circle cx="8.5" cy="11.5" r="1.5" fill="#3b82f6"/>
                <path d="M15.5 9.5 L8.5 11.5" stroke="#3b82f6" stroke-width="1.5"/>
            </svg>
            <span class="logo-text">NeuroStudy AI</span>
        </div>

        <nav class="flex-1">
            <div class="nav-item active" id="nav-dashboard" onclick="window.switchTab('dashboard')">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                Dashboard
            </div>
            <div class="nav-item" id="nav-cycle" onclick="window.switchTab('cycle')">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                Estudos
            </div>
            
            <div class="nav-section-title">AnÃ¡lise</div>
            <div class="nav-item opacity-50 cursor-not-allowed">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                Ranking
            </div>
            
            <div class="nav-section-title">Sistema</div>
            <div class="nav-item opacity-50 cursor-not-allowed">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                ConfiguraÃ§Ãµes
            </div>
        </nav>

        <div class="status-area">
            <div id="user-profile" class="flex items-center gap-3 mb-4" style="display: none;">
                <img id="user-avatar" class="w-8 h-8 rounded-full bg-gray-700 border border-gray-600">
                <div class="flex flex-col overflow-hidden">
                    <span class="text-xs text-gray-300 font-medium">UsuÃ¡rio</span>
                    <button onclick="window.firebaseApp.logout()" class="text-xs text-red-400 hover:text-red-300 text-left">Sair</button>
                </div>
            </div>
            <button id="btn-login" onclick="window.firebaseApp.login()" class="btn btn-primary w-full justify-center mb-4 text-xs font-bold">
                Entrar com Google
            </button>
            <div class="flex items-center gap-2">
                <div id="status-dot" class="w-2 h-2 rounded-full bg-gray-500"></div>
                <span id="status-text" class="text-xs text-gray-500">Offline</span>
            </div>
        </div>
    </aside>

    <!-- MAIN -->
    <main class="main-content">
        
        <!-- DASHBOARD -->
        <div id="view-dashboard">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h2 class="text-2xl font-bold text-white">Dashboard</h2>
                    <p class="text-sm text-gray-400 mt-1">VisÃ£o geral do seu progresso.</p>
                </div>
                <!-- NeuroCoach Button -->
                <button onclick="window.consultCoach()" class="btn btn-secondary text-sm text-purple-400 hover:text-purple-300 border-purple-500/30 hover:border-purple-500/80 gap-2 transition-all">
                    âœ¨ NeuroCoach IA
                </button>
            </div>

            <!-- AI Feedback Area -->
            <div id="coach-feedback" class="card mb-6 hidden border-l-4 border-purple-500 bg-[#151a23] p-6 shadow-lg">
                <h4 class="text-purple-400 font-bold mb-3 flex items-center gap-2 text-sm uppercase tracking-wide">
                    ðŸ¤– AnÃ¡lise EstratÃ©gica
                </h4>
                <div id="coach-text" class="text-gray-300 text-sm leading-relaxed markdown-content"></div>
            </div>

            <div class="kpi-grid">
                <div class="kpi-card">
                    <span class="kpi-label">Ciclos ConcluÃ­dos</span>
                    <span class="kpi-value" id="kpi-total">0</span>
                </div>
                <div class="kpi-card">
                    <span class="kpi-label">Desempenho Global</span>
                    <div class="flex items-end gap-2">
                        <span class="kpi-value text-blue-400" id="kpi-perf">0%</span>
                        <span class="text-xs text-gray-500 mb-2">de acertos</span>
                    </div>
                </div>
                <div class="kpi-card">
                    <span class="kpi-label">RevisÃµes Pendentes</span>
                    <span class="kpi-value text-red-400" id="kpi-rev">0</span>
                </div>
                <div class="kpi-card">
                    <span class="kpi-label">Progresso Total</span>
                    <span class="kpi-value text-green-400">76%</span>
                    <div class="w-full bg-gray-700 h-1.5 rounded-full mt-2 overflow-hidden">
                        <div class="bg-green-500 h-1.5 rounded-full" style="width: 76%"></div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Ranking -->
                <div class="card h-96">
                    <h3 class="text-base font-semibold text-white mb-6">Ranking de Disciplinas</h3>
                    <div class="chart-container h-64">
                        <canvas id="radarChart"></canvas>
                    </div>
                </div>

                <!-- Stats Recentes -->
                <div class="card h-96">
                    <h3 class="text-base font-semibold text-white mb-6">EstatÃ­sticas Recentes</h3>
                    <div class="chart-container h-64">
                        <canvas id="lineChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- CYCLE -->
        <div id="view-cycle" style="display: none;">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-white">Estudos</h2>
                    <p class="text-sm text-gray-400 mt-1">Gerencie suas disciplinas e revisÃµes.</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="window.showInlineAddDiscipline()" class="btn btn-primary">+ Disciplina</button>
                    <button onclick="window.filterToday()" id="btn-hoje" class="btn btn-secondary">ðŸ”¥ Hoje</button>
                    <button onclick="window.calcSmartCycle()" class="btn btn-ai gap-2">
                        <span>ðŸ§ </span> Prioridade IA
                    </button>
                </div>
            </div>

            <!-- Add Form -->
            <div id="inline-add-discipline" class="card mb-6 hidden flex items-center gap-4 border-l-4 border-blue-500 p-4">
                <input type="text" id="new-disc-name" placeholder="Nome..." class="input-clean bg-black border border-gray-700 w-64 p-2">
                <select id="new-disc-weight" class="input-clean bg-black border border-gray-700 w-24 p-2">
                    <option value="1">Peso 1</option>
                    <option value="2">Peso 2</option>
                    <option value="3" selected>Peso 3</option>
                </select>
                <button onclick="window.addDisciplineInline()" class="btn btn-primary text-xs">Salvar</button>
                <button onclick="window.hideInlineAddDiscipline()" class="btn btn-secondary text-xs">Cancelar</button>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 30px;"></th>
                            <th class="text-left" style="min-width: 250px;">DISCIPLINA / TÃ“PICO</th>
                            <th class="text-center w-20">REL %</th>
                            <th class="text-center w-16">PESO</th>
                            <th class="text-center w-20">QTD</th>
                            <th class="text-center w-20">ACERT</th>
                            <th class="text-center w-16 text-blue-400 font-bold">%</th>
                            <th class="text-center w-20">LINK</th>
                            <th class="text-center w-12">OK</th>
                            
                            <!-- REVISÃ•ES: 2 Colunas por R -->
                            <th class="text-center w-8 border-l-rev text-gray-500" title="Status R1">R1</th>
                            <th class="text-center w-24 text-xs font-normal text-gray-600">Q / A / %</th>
                            
                            <th class="text-center w-8 border-l-rev text-gray-500" title="Status R7">R7</th>
                            <th class="text-center w-24 text-xs font-normal text-gray-600">Q / A / %</th>

                            <th class="text-center w-8 border-l-rev text-gray-500" title="Status R15">R15</th>
                            <th class="text-center w-24 text-xs font-normal text-gray-600">Q / A / %</th>

                            <th class="text-center w-8 border-l-rev text-gray-500" title="Status R30">R30</th>
                            <th class="text-center w-24 text-xs font-normal text-gray-600">Q / A / %</th>

                            <th class="text-center w-8 border-l-rev text-gray-500" title="Status R60">R60</th>
                            <th class="text-center w-24 text-xs font-normal text-gray-600">Q / A / %</th>

                            <th class="text-center w-8 border-l-rev text-gray-500" title="Status R90">R90</th>
                            <th class="text-center w-24 text-xs font-normal text-gray-600">Q / A / %</th>
                            
                            <th style="width: 40px;"></th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <!-- Rows rendered via JS -->
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <!-- Modal IA -->
    <div id="smart-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] hidden items-center justify-center p-4">
        <div class="card w-full max-w-2xl bg-[#151a23] border border-gray-700 shadow-2xl">
            <div class="flex justify-between items-center border-b border-gray-700 pb-4 mb-4">
                <h3 class="text-lg font-bold text-white flex gap-2 items-center"><span class="text-purple-400">âœ¨</span> Gemini IA</h3>
                <button onclick="window.closeModal()" class="text-gray-500 hover:text-white">âœ•</button>
            </div>
            <div id="smart-loading" class="hidden py-12 text-center">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-purple-500 mb-2"></div>
                <p class="text-purple-400 text-sm">Processando dados com a IA...</p>
            </div>
            <div id="smart-content" class="space-y-4 max-h-[60vh] overflow-y-auto markdown-content text-gray-300"></div>
        </div>
    </div>

    <script>
        "use strict";
        const apiKey = ""; // API Key (Set by Environment or manually)

        window.appData = [];
        window.isFilterTodayActive = false;
        const charts = {};
        const SEED = [{ id: 'd1', name: 'MatemÃ¡tica', weight: 3, expanded: true, contents: [{ id: 'c1', name: 'Ãlgebra', cob: 50, ex: 10, ac: 8, date: new Date().toISOString().split('T')[0], revs: [0,0,0,0,0,0], revEx:[0,0,0,0,0,0], revAc:[0,0,0,0,0,0] }] }];
        const REVISION_INTERVALS = [1, 7, 15, 30, 60, 90];

        // --- GEMINI API ---
        async function callGemini(prompt) {
            // Check if key exists
            if (!apiKey) {
                return "âš ï¸ **ConfiguraÃ§Ã£o NecessÃ¡ria:** A chave da API do Gemini nÃ£o foi detectada. Adicione sua chave na variÃ¡vel `apiKey` no cÃ³digo fonte.";
            }

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                
                if (!response.ok) throw new Error('Falha na resposta da API');
                
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "A IA nÃ£o retornou conteÃºdo.";
            } catch (e) { 
                console.error(e);
                return "âŒ Erro ao conectar com a IA. Verifique sua conexÃ£o e chave de API."; 
            }
        }

        // 1. NEURO COACH
        window.consultCoach = async () => {
            const fb = document.getElementById('coach-feedback');
            const txt = document.getElementById('coach-text');
            
            fb.classList.remove('hidden');
            txt.innerHTML = '<div class="flex items-center gap-2"><div class="w-2 h-2 bg-purple-500 rounded-full animate-bounce"></div> Consultando o Coach...</div>';
            
            let totalQ = 0, totalA = 0;
            window.appData.forEach(d => d.contents.forEach(c => { totalQ += Number(c.ex)||0; totalA += Number(c.ac)||0; }));
            const acc = totalQ > 0 ? ((totalA/totalQ)*100).toFixed(0) : 0;
            
            const prompt = `Atue como um mentor rÃ­gido mas motivador para concursos fiscais.
            O aluno fez ${totalQ} questÃµes com ${acc}% de acerto.
            DÃª: 
            1) Um diagnÃ³stico curto e direto.
            2) Uma aÃ§Ã£o prÃ¡tica imediata (bullet point).
            Use Markdown.`;
            
            const res = await callGemini(prompt);
            txt.innerHTML = marked.parse(res);
        }
        
        // 2. SMART CYCLE
        window.calcSmartCycle = async () => {
             document.getElementById('smart-modal').style.display = 'flex';
             document.getElementById('smart-loading').style.display = 'block';
             document.getElementById('smart-content').innerHTML = '';
             
             const simplifiedData = window.appData.map(d => ({
                 n: d.name, w: d.weight,
                 t: d.contents.map(c => ({ n: c.name, ex: c.ex, ac: c.ac }))
             }));

             const prompt = `Analise este estudo (JSON): ${JSON.stringify(simplifiedData).substring(0, 1500)}...
             Sugira 3 prioridades de estudo baseadas em Custo-BenefÃ­cio (Peso alto + Baixo acerto).
             Retorne APENAS um JSON: [{"topic": "TÃ³pico", "discipline": "MatÃ©ria", "reason": "Motivo curto"}]`;

             try {
                 const raw = await callGemini(prompt);
                 // Simple cleanup if AI wraps in markdown block
                 const clean = raw.replace(/```json/g, '').replace(/```/g, '').trim();
                 
                 // Fallback if not JSON
                 if (!clean.startsWith('[')) throw new Error("Resposta invÃ¡lida");
                 
                 const data = JSON.parse(clean);
                 
                 let html = '';
                 data.forEach((d, i) => {
                     html += `<div class="p-4 bg-gray-800 rounded-lg border-l-4 border-purple-500 mb-3 hover:bg-gray-750 transition">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs font-bold text-purple-300 uppercase tracking-wider">${d.discipline}</span>
                            <span class="text-xs text-gray-500 font-mono">#${i+1}</span>
                        </div>
                        <div class="font-bold text-white text-base">${d.topic}</div>
                        <div class="text-sm text-gray-400 mt-2">ðŸ’¡ ${d.reason}</div>
                     </div>`;
                 });
                 document.getElementById('smart-content').innerHTML = html;
             } catch(e) { 
                 document.getElementById('smart-content').innerHTML = marked.parse(await callGemini("DÃª 3 dicas gerais de estudo para Ã¡rea fiscal pois nÃ£o tenho dados suficientes."));
             }
             document.getElementById('smart-loading').style.display = 'none';
        }

        // 3. TOPIC EXPLAINER
        window.explainTopic = async (topicName, discName) => {
            document.getElementById('smart-modal').style.display = 'flex';
            document.getElementById('smart-loading').style.display = 'block';
            document.getElementById('smart-content').innerHTML = '';
            
            const prompt = `Crie um resumo de elite para concurso sobre: "${topicName}" (${discName}).
            Markdown:
            ### ðŸ“š Conceito
            (Resumo em 1 frase)
            ### âš ï¸ O que cai
            - Ponto 1
            - Ponto 2
            ### ðŸ’¡ Macete
            (Dica rÃ¡pida)`;
            
            const res = await callGemini(prompt);
            document.getElementById('smart-loading').style.display = 'none';
            document.getElementById('smart-content').innerHTML = marked.parse(res);
        }

        // --- CORE LOGIC (Standard App) ---
        function calculateReviews(dateStr) {
            if (!dateStr) return Array(REVISION_INTERVALS.length).fill({ date: null, isDue: false });
            const base = new Date(dateStr); base.setHours(0,0,0,0);
            const today = new Date(); today.setHours(0,0,0,0);
            return REVISION_INTERVALS.map(d => {
                const due = new Date(base); due.setDate(due.getDate() + d);
                return { date: d, isDue: due <= today };
            });
        }

        function getPerfColor(val) {
            if(val >= 0.85) return 'text-green-400';
            if(val >= 0.70) return 'text-yellow-400';
            return 'text-red-400';
        }

        window.renderTable = function(filterToday = false, fromCloud = false) {
            if(fromCloud) window.isFilterTodayActive = filterToday;
            const tbody = document.getElementById('table-body');
            if(!tbody) return;
            tbody.innerHTML = '';
            
            let hasRows = false;
            (window.appData || []).forEach(disc => {
                if (!filterToday) {
                    const tr = document.createElement('tr');
                    tr.className = 'tr-disciplina';
                    tr.onclick = () => window.toggleDisc(disc.id);
                    tr.innerHTML = `
                        <td class="text-center text-gray-500 cursor-pointer">${disc.expanded ? 'â–¼' : 'â–¶'}</td>
                        <td>
                            <div class="flex flex-col">
                                <input readonly ondblclick="this.readOnly=false;this.focus()" onblur="this.readOnly=true" onkeydown="if(event.key==='Enter')this.blur()" class="input-clean font-bold text-white text-base" value="${disc.name}" onchange="window.updateDisc('${disc.id}', 'name', this.value)" onclick="event.stopPropagation()">
                                <button onclick="event.stopPropagation(); window.addContent('${disc.id}')" class="btn-text text-left pl-2 text-xs uppercase font-bold tracking-wide">+ TÃ³pico</button>
                            </div>
                        </td>
                        <td></td>
                        <td class="text-center"><input class="input-clean text-center w-12 mx-auto text-gray-400" value="${disc.weight}" onchange="window.updateDisc('${disc.id}', 'weight', this.value)" onclick="event.stopPropagation()"></td>
                        <td colspan="19"></td>
                    `;
                    tbody.appendChild(tr);
                }

                if (disc.expanded || filterToday) {
                    disc.contents.forEach(cont => {
                        const revs = calculateReviews(cont.date);
                        if(filterToday && (!cont.date || !revs.some((r,i) => !cont.revs[i] && r.isDue))) return;
                        hasRows = true;

                        const tr = document.createElement('tr');
                        tr.className = 'tr-conteudo';
                        const perf = cont.ex > 0 ? ((cont.ac/cont.ex)*100).toFixed(0)+'%' : '-';
                        const perfClass = cont.ex > 0 ? getPerfColor(cont.ac/cont.ex) : 'text-gray-600';
                        
                        const linkDisplay = cont.link ? `<a href="${cont.link}" target="_blank" class="text-blue-400 hover:underline text-xs">Link â†—</a>` : '<span class="text-gray-700">-</span>';
                        const linkInput = `<input class="input-clean text-xs text-blue-400 hidden edit-link" value="${cont.link||''}" onblur="window.saveLink(this, '${disc.id}', '${cont.id}')" placeholder="URL">`;

                        let revCells = '';
                        revs.forEach((r, i) => {
                            let dot = 'status-dot';
                            if(cont.date) {
                                if(cont.revs[i]) dot += ' done';
                                else if(r.isDue) dot += ' pending';
                                else dot += ' today';
                            }
                            
                            const rex = cont.revEx?.[i] || '';
                            const rac = cont.revAc?.[i] || '';
                            const rPerc = (rex > 0) ? ((rac/rex)*100).toFixed(0)+'%' : '-';
                            const rClass = (rex > 0) ? getPerfColor(rac/rex) : 'text-gray-600';
                            
                            revCells += `
                                <td class="text-center border-l-rev">
                                    <div class="${dot} mb-1" onclick="window.toggleRev('${disc.id}', '${cont.id}', ${i})"></div>
                                </td>
                                <td class="text-center px-1">
                                    <div class="flex flex-col items-center justify-center gap-1">
                                        <div class="flex gap-1">
                                            <input class="input-mini" placeholder="Q" value="${rex}" onchange="window.updateRevStats('${disc.id}', '${cont.id}', ${i}, 'revEx', this.value)">
                                            <input class="input-mini" placeholder="A" value="${rac}" onchange="window.updateRevStats('${disc.id}', '${cont.id}', ${i}, 'revAc', this.value)">
                                        </div>
                                        <span class="text-[0.6rem] font-bold ${rClass}">${rPerc}</span>
                                    </div>
                                </td>
                            `;
                        });

                        tr.innerHTML = `
                            <td></td>
                            <td><input readonly ondblclick="this.readOnly=false;this.focus()" onblur="this.readOnly=true" onkeydown="if(event.key==='Enter')this.blur()" class="input-clean text-gray-300" value="${cont.name}" onchange="window.updateContent('${disc.id}', '${cont.id}', 'name', this.value)"></td>
                            <td class="text-center"><input class="input-clean text-center text-xs" value="${cont.cob||0}" onchange="window.updateContent('${disc.id}', '${cont.id}', 'cob', this.value)"></td>
                            <td></td>
                            <td class="text-center"><input class="input-clean text-center text-xs w-12 mx-auto bg-gray-800/50 rounded" value="${cont.ex}" onchange="window.updateContent('${disc.id}', '${cont.id}', 'ex', this.value)"></td>
                            <td class="text-center"><input class="input-clean text-center text-xs w-12 mx-auto bg-gray-800/50 rounded" value="${cont.ac}" onchange="window.updateContent('${disc.id}', '${cont.id}', 'ac', this.value)"></td>
                            <td class="text-center font-bold text-xs ${perfClass}">${perf}</td>
                            <td class="text-center" ondblclick="window.editLink(this)"><div class="view-link">${linkDisplay}</div>${linkInput}</td>
                            <td class="text-center"><input type="checkbox" class="checkbox-clean" ${cont.date?'checked':''} onchange="window.toggleDate('${disc.id}','${cont.id}',this.checked)"></td>
                            ${revCells}
                            <td class="text-center flex items-center justify-center gap-2 pt-3">
                                <button class="btn-icon-only" onclick="window.explainTopic('${cont.name}', '${disc.name}')" title="Flashcard IA">âœ¨</button>
                                <button class="text-gray-600 hover:text-red-500" onclick="window.deleteContent('${disc.id}', '${cont.id}')">âœ•</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            });
            if(filterToday && !hasRows) tbody.innerHTML = '<tr><td colspan="20" class="text-center py-8 text-gray-500">Nada para hoje.</td></tr>';
        };

        // UI & Logic Wrappers
        window.switchTab = function(tab) {
            ['dashboard', 'cycle'].forEach(t => {
                document.getElementById(`view-${t}`).style.display = 'none';
                document.getElementById(`nav-${t}`).classList.remove('active');
            });
            document.getElementById(`view-${tab}`).style.display = 'block';
            document.getElementById(`nav-${tab}`).classList.add('active');
            if(tab === 'dashboard') window.updateStats();
            else window.renderTable(window.isFilterTodayActive);
        }

        window.toggleDisc = (id) => { let d=window.appData.find(x=>x.id===id); if(d){d.expanded=!d.expanded; window.saveData(); window.renderTable(window.isFilterTodayActive);} };
        window.updateDisc = (id,f,v) => { let d=window.appData.find(x=>x.id===id); if(d){d[f]=v; window.saveData();} };
        window.updateContent = (dId,cId,f,v) => { 
            let d=window.appData.find(x=>x.id===dId); if(!d)return;
            let c=d.contents.find(x=>x.id===cId); if(!c)return;
            if(['name','link'].includes(f)) c[f]=v; else c[f]=Number(v)||0;
            window.saveData(); window.renderTable(window.isFilterTodayActive);
        };
        window.toggleDate = (dId,cId,chk) => {
            let d=window.appData.find(x=>x.id===dId); if(!d)return;
            let c=d.contents.find(x=>x.id===cId); if(!c)return;
            c.date = chk ? new Date().toISOString().split('T')[0] : '';
            window.saveData(); window.renderTable(window.isFilterTodayActive);
        };
        window.updateRevStats = (dId,cId,idx,f,v) => {
            let d=window.appData.find(x=>x.id===dId); if(!d)return;
            let c=d.contents.find(x=>x.id===cId); if(!c)return;
            if(!c.revEx)c.revEx=[0,0,0,0,0,0]; if(!c.revAc)c.revAc=[0,0,0,0,0,0];
            c[f][idx]=v; window.saveData(); window.renderTable(window.isFilterTodayActive);
        };
        window.toggleRev = (dId,cId,idx) => {
            let d=window.appData.find(x=>x.id===dId); if(!d)return;
            let c=d.contents.find(x=>x.id===cId); if(!c)return;
            c.revs[idx] = c.revs[idx]?0:1; window.saveData(); window.renderTable(window.isFilterTodayActive);
        };
        window.addDisciplineInline = () => {
            const name = document.getElementById('new-disc-name').value;
            if(!name) return;
            window.appData.push({ id:'d'+Date.now(), name, weight:1, expanded:true, contents:[] });
            window.saveData(); window.hideInlineAddDiscipline(); window.renderTable(window.isFilterTodayActive);
        };
        window.addContent = (dId) => {
            let d=window.appData.find(x=>x.id===dId);
            d.contents.push({ id:'c'+Date.now(), name:'Novo TÃ³pico', cob:0, ex:0, ac:0, date:'', revs:[0,0,0,0,0,0], revEx:[0,0,0,0,0,0], revAc:[0,0,0,0,0,0] });
            window.saveData(); window.renderTable(window.isFilterTodayActive);
        };
        window.deleteContent = (dId, cId) => {
            if(!confirm('Excluir?')) return;
            let d=window.appData.find(x=>x.id===dId);
            d.contents = d.contents.filter(x=>x.id!==cId);
            window.saveData(); window.renderTable(window.isFilterTodayActive);
        };
        
        window.showInlineAddDiscipline = () => document.getElementById('inline-add-discipline').style.display = 'flex';
        window.hideInlineAddDiscipline = () => document.getElementById('inline-add-discipline').style.display = 'none';
        window.filterToday = () => { window.isFilterTodayActive = !window.isFilterTodayActive; window.renderTable(window.isFilterTodayActive); };
        window.editLink = (el) => { el.querySelector('.view-link').style.display='none'; el.querySelector('.edit-link').style.display='block'; el.querySelector('.edit-link').focus(); };
        window.saveLink = (el, dId, cId) => { window.updateContent(dId, cId, 'link', el.value); window.renderTable(window.isFilterTodayActive); };
        window.closeModal = () => document.getElementById('smart-modal').style.display = 'none';

        window.updateStats = function() {
            let tot=0, ac=0, rev=0, dS={};
            const today = new Date(); today.setHours(0,0,0,0);
            (window.appData||[]).forEach(d => {
                dS[d.name] = {ex:0, ac:0};
                d.contents.forEach(c => {
                    tot += Number(c.ex)||0; ac += Number(c.ac)||0;
                    dS[d.name].ex += Number(c.ex)||0; dS[d.name].ac += Number(c.ac)||0;
                    if(c.date) {
                        calculateReviews(c.date).forEach((r,i) => { if(!c.revs[i] && r.isDue) rev++; });
                    }
                });
            });
            document.getElementById('kpi-total').innerText = tot;
            document.getElementById('kpi-perf').innerText = tot>0?((ac/tot)*100).toFixed(0)+'%':'0%';
            document.getElementById('kpi-rev').innerText = rev;
            
            const ctx = document.getElementById('radarChart');
            if(ctx && charts.radar) {
                charts.radar.data.labels = Object.keys(dS);
                charts.radar.data.datasets[0].data = Object.values(dS).map(v => v.ex>0 ? (v.ac/v.ex)*100 : 0);
                charts.radar.update();
            }
        };

        window.onload = function() {
            try { const local = localStorage.getItem('neuro_fiscal_pro_v6'); if(local) window.appData = JSON.parse(local); else window.appData = SEED; } catch(e) { window.appData = SEED; }
            
            const ctx = document.getElementById('radarChart').getContext('2d');
            charts.radar = new Chart(ctx, {
                type: 'bar',
                data: { labels: [], datasets: [{ label: 'Desempenho %', data: [], backgroundColor: '#3b82f6', borderRadius: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100, grid: { color: '#252b36' } }, x: { grid: { display: false } } }, plugins: { legend: { display: false } } }
            });
            
            const ctx2 = document.getElementById('lineChart').getContext('2d');
            charts.line = new Chart(ctx2, {
                type: 'line',
                data: { labels: ['S','T','Q','Q','S','S','D'], datasets: [{ label: 'QuestÃµes', data: [0,0,0,0,0,0,0], borderColor: '#10b981', tension: 0.4 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { grid: { color: '#252b36' } }, x: { grid: { display: false } } }, plugins: { legend: { display: false } } }
            });

            window.renderTable(false);
            window.updateStats();
            window.switchTab('dashboard');
        };
    </script>
</body>
</html>